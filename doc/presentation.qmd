---
title: "Global Tuberculosis cases - WHO 2025 report\nProject Presentation - 22160 R for Bio Data Science"
authors: "Henrik (s215065), Felipe (s252623), Lun (s253705),\
Bhavya (s252641), Dhruva (s225191)"
date: "2 dec 2025"

format:
  revealjs:
    slide-number: true
    footer: ""
    css: styles.css
    code-font-size: "0.7em"
---

**1) Introduction to the data**

##### WHO Data

TB mortality and incidence (by age, sex, HIV status, risk factors, drug resistance)

Disaggregated incidence by age group, sex, and risk factors

MDR/RR-TB burden estimates

TB infection estimates in household contacts

##### Our Project Focus

------------------------------------------------------------------------

**2) Cleaning the data**

1.  Load raw WHO datasets (TB burden, age/sex, MDR/RR, LTBI).

2.  Explore data & run QC (glimpse, missingness, coverage).

3.  Remove redundant columns (iso codes, empty HIV bounds).

4.  Standardize variable names (cdr_pct, rr_incidence, Preventive_Tx).

5.  Recode categorical variables (sex, risk factors).

6.  Clean strings & metadata (age formatting, survey sources).

7.  Identify missingness patterns (Namibia, DPRK, RR gaps).

8.  Validate with checks (summaries, year structure).

9.  Save cleaned datasets (burden, age/sex, LTBI, MDR/RR).

------------------------------------------------------------------------

**3) Augmenting the data. e.g. standardardized (pr. 100k) vs normal**

::::: columns
::: {.column width="50%" style="font-size: 0.9em"}
**Joining datasets:**

```{r 3_1, echo=TRUE, eval=FALSE}
#Code for joining dataset (2024):
population_data_2024 <- TB_burden |>
  select(country, e_pop_num, year) |>
  filter(year == 2024) |>
  rename(population_size = e_pop_num)
TB_age_sex <- left_join(TB_age_sex, population_data_2024, by = c("country", "year"))
```

```{r 3_2, echo=TRUE, eval=FALSE}
#Code for joining dataset (2015-2024):
TB_10_years <- inner_join(TB_burden, mdr_rr_data, by = c("country", "year"))
TB_10_years <- inner_join(TB_10_years, ltbi_data, by = c("country", "year"))
```

![](../results/images/04_1_top10_TB.png){width="2000"}
:::

::: {.column width="50%" style="font-size: 0.9em"}
The datasets contain TB cases for a given country. However, having a large population size (India and China), will also cause the overall TB cases to be larger for such countries.

**Solution:** Standardize the data! (I.e. amount of people with TB out of every pr. 100,000 citizen).

```{r 3_3, echo=TRUE, eval=FALSE}
#Data augmentation - Calculating the TB cases pr. 100k (standardizing the data): 
TB_age_sex <- TB_age_sex |>
  group_by(country) |>
  
  #Getting the total sum of TB cases for every country
  mutate( 
    total_TB_cases_best = sum(TB_cases_best), 
    total_TB_cases_min = sum(TB_cases_min), 
    total_TB_cases_max = sum(TB_cases_max)
    ) |> 
      #calculate the pr. 100k amount of cases
  mutate( 
        TB_cases_pr_100k_best = TB_cases_best/population_size*10^5,
        TB_cases_pr_100k_min = TB_cases_min/population_size*10^5,
        TB_cases_pr_100k_max = TB_cases_max/population_size*10^5,
        )
```

![](../results/images/04_2_top10_TB_100k.png){width="2000"}
:::
:::::

------------------------------------------------------------------------

**4) Analysis - 2024 dataset - TB + Risk factor distribution**

::::: columns
::: {.column width="50%" style="font-size: 0.9em"}
**Bar chart - TB + Risk factor cases in the top 10 most TB burdened countries:**

```{r 4_1, echo=TRUE, eval=FALSE}
#Code for making the plot of the TB + risk factor cases:
TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  group_by(country, risk_factor) |>
  filter(risk_factor != "no risk factor") |>
  summarise(
    TB_cases_best = sum(TB_cases_best),
    TB_cases_min = sum(TB_cases_min),
    TB_cases_max = sum(TB_cases_max),
    population_size = first(population_size),
    TB_cases_best_100k = TB_cases_best/population_size*10^5,
    TB_cases_min_100k = TB_cases_min/population_size*10^5,
    TB_cases_max_100k = TB_cases_max/population_size*10^5,
  ) #... followed by ggplot
```

**Bar chart of the risk factor distribution:** **(Without the 'no risk factor' label)**

![](../results/images/06_1_riskfactor_barchart.png){width="2000"}
:::

::: {.column width="50%" style="font-size: 0.9em"}
**Box plots of the global risk factor distribution:**

``` r
TB_age_sex |>
  group_by(country, risk_factor) |>
  filter(risk_factor != "no risk factor") |>
  summarise(
    TB_cases_best = sum(TB_cases_best),
    TB_cases_min = sum(TB_cases_min),
    TB_cases_max = sum(TB_cases_max),
    population_size = first(population_size),
    
    TB_cases_best_100k = TB_cases_best/population_size*10^5,
    TB_cases_min_100k = TB_cases_min/population_size*10^5,
    TB_cases_max_100k = TB_cases_max/population_size*10^5,
  ) #... followed by ggplot
```

**Box plot of TB + risk factor cases, globally:** 

![](../results/images/06_2_riskfactor_boxplot.png){width="2000"}
:::
:::::

------------------------------------------------------------------------

**5) Analysis 2 - 2024 Dataset - TB age and sex distribution**

(E.g. global cases)

::::: columns
::: {.column width="50%" style="font-size: 0.9em"}
```{r 5_1, echo=TRUE, eval=FALSE}
TB_age_sex |>
  group_by(country, sex) |>
  summarise( #getting the summed TB case values for each country and sex.
    TB_best_100k = sum(TB_cases_best)/first(population_size)*10^5, #Use first(),
    # as the same value is repeated on several rows, for each country. 
    TB_min_100k = sum(TB_cases_min)/first(population_size)*10^5,
    TB_max_100k = sum(TB_cases_max)/first(population_size)*10^5,
  ) |>
  filter(country %in% top_10_countries_100k) |> #<-- The new change. 
  
  #The box plot:
  ggplot(aes(y = TB_best_100k, x = sex)) +  #It will be the distribution of TB pr. 100k for every sex group. 
    geom_boxplot(alpha = 1, fill = "orange") +
    theme(legend.position = "none") +
  labs(
    x = "Sex",
    y = "TB cases per 100k, for each sex, for country\n(Best estimate)",
    title = "Sex-divided amount of TB cases pr. 100k citizens\nOnly for the 10 countries with highest TB cases pr. 100k"
  )
```

![](../results/images/06_3_sexdistribution_boxplot.png){width="2000"}
:::

::: {.column width="50%" style="font-size: 0.9em"}

Sex distribution in most burdened countries with TB

```{r 5_2, echo=TRUE, eval=FALSE}
TB_age_sex |>
  group_by(country, sex) |>
  summarise( #getting the summed TB case values for each country and sex.
    TB_best_100k = sum(TB_cases_best)/first(population_size)*10^5, #Use first(),
    # as the same value is repeated on several rows, for each country. 
    TB_min_100k = sum(TB_cases_min)/first(population_size)*10^5,
    TB_max_100k = sum(TB_cases_max)/first(population_size)*10^5,
  ) |>
  filter(country %in% top_10_countries_100k) |>
  ggplot(aes(x = TB_best_100k, y = country, color = sex)) +
    geom_point(position = position_dodge(width = 0.5), size = 3) +
    geom_errorbarh(
      aes(xmin = TB_min_100k, xmax = TB_max_100k),
      position = position_dodge(width = 0.5),
      height = 0.4) +
    labs(
      x = "TB cases per 100k\n(Best estimate with min/max)",
      y = "Country",
      title = "TB cases pr. 100k by sex\n(Countries with top 10 most TB cases pr. 100k)") +
    theme_minimal()
```

**Scatter plot of TB cases by sex in most burdened countries:**

![](../results/images/06_3_sexdistribution_boxplot.png){width="2000"}
##Bhavya erase this, and change the image

:::
:::::

------------------------------------------------------------------------

**6) Analysis 2 - part 2**

(E.g. age distribution)

------------------------------------------------------------------------

**7) Analysis 1 - part 1**


::::: columns
::: {.column width="50%" style="font-size: 0.9em"}
```{r 7_1, echo=TRUE, eval=FALSE}
geom_polygon(aes(fill = e_inc_100k)
```

![](images/05_evolution_tb_incidence.png){width="1500"}
:::

::: {.column width="50%" style="font-size: 0.9em"}
```{r 7_2, echo=TRUE, eval=FALSE}
geom_polygon(aes(fill = Preventive_Tx_Pct)
```

![](images/05_evolution_TPT.png){width="1500"}
:::
:::::

------------------------------------------------------------------------

**8) Analysis 1 - part 2**

::::: columns
::: {.column width="50%" style="font-size: 0.9em"}
```{r 8_1, echo=TRUE, eval=FALSE}

gap_analysis <- TB_10_years_joined |>
  filter(year == 2024) |>
  filter(!is.na(Preventive_Tx_Pct) & !is.na(Contacts_best))

# 2. Define Dynamic Thresholds
# Burden Threshold: Top 10% of countries with the most contacts
burden_threshold <- quantile(gap_analysis$Contacts_best, 0.90) 

# Coverage Threshold: Less than 40% coverage
coverage_threshold <- 40

# 3. Create a Flag for High Risk Countries
gap_analysis <- gap_analysis |>
  mutate(
    Is_High_Risk = if_else(Contacts_best >= burden_threshold & Preventive_Tx_Pct < coverage_threshold, 
                           "High Risk (High Burden, Low Coverage)", 
                           "Other")
  )
```

![](../results/images/05_burden_treatment.png){width="600"}

:::

::: {.column width="50%" style="font-size: 0.9em"}
```{r 8_2, echo=TRUE, eval=FALSE}

df_clean <- df |>
  mutate(TPT_Contacts_Num = Contacts_best * Preventive_Tx_Pct / 100)

global_trends <- df_clean |>
  filter(year >= 2015) |>
  group_by(year) |>
  summarise(
    Total_TPT_Contacts = sum(TPT_Contacts_Num, na.rm = TRUE),
    Total_Contacts_Eligible = sum(Contacts_best, na.rm = TRUE),
    Avg_Child_Coverage = mean(Preventive_Tx_Kids_Pct, na.rm = TRUE)
  ) |>
  mutate(Contact_Coverage = (Total_TPT_Contacts / Total_Contacts_Eligible) * 100)
```

![](../results/images/05_coverage.png){width="1500"}
:::
:::::

------------------------------------------------------------------------

**9) Analysis on data from 2015 to 2024:**

::::: columns
::: {.column width="50%" style="font-size: 0.9em"}

**Scatter plot with linear regresion per country:**

```{r 9_1, echo=TRUE, eval=FALSE}
TB_10_years_joined |>
  ggplot(aes(x=(rr_incidence/e_pop_num*10^5),y=e_mort_100k, color=g_whoregion.x)) +
  geom_point(alpha = 0.45)+
  geom_smooth(method='lm', se = FALSE)+
  coord_cartesian(xlim=c(0,45), ylim=c(0,150)) +  #Eye calculated good limit for the plot
  scale_color_brewer(palette = "Set2",
    labels = labels$label,
    breaks = labels$g_whoregion.x) +
  labs(
        x = "RR - TB", 
        y = "Mortality", 
        title = "Relation between RR - TB and Mortality per region", 
        color = "WHO Region") +
  theme_minimal()
```

![](../results/images/05_analysis_relationship_RRTB_Mortality.png){width="2000"}
:::

::: {.column width="50%" style="font-size: 0.9em"}

**Box plots of mortality percentages based on different combinations of TB and HIV:**

```{r 9_2, echo=TRUE, eval=FALSE}
TB_10_years_joined |>
mutate(
disease = case_when(
  e_tbhiv_prct > mean(e_tbhiv_prct, na.rm = TRUE) & rr_new > mean(rr_new, na.rm = TRUE) ~ "HIV & RR-TB",
  e_tbhiv_prct > mean(e_tbhiv_prct, na.rm = TRUE) ~ "HIV & TB",
  rr_new > mean(rr_new, na.rm = TRUE) ~ "Only RR-TB",
  TRUE ~ "Only TB"
)) |>
ggplot(aes(x=disease, y =e_mort_100k, fill = disease))+
geom_boxplot() +
scale_fill_brewer(palette = "Set2") + 
labs(
    x = "",
    y = "Mortality cases per 100k",
    subtitle = "Mortality according to combinations of HIV and RR-TB",
    fill = "Disease"
  ) +
  theme_minimal()
```

![](../results/images/05_analysis_mortality_cases_per_100k.png){width="2000"}
:::
:::::

------------------------------------------------------------------------

**10) Conclusion/ wrapping up**

(Heatmaps and PCA for analysis 2)
