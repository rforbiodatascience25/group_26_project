---
title: "05_analysis_1"
format: html
---

possible questions

how do TB incidence and mortality trends vary across countries and over time?

how do MDR/RR-TB trends compare to overall TB trends?

how are household TB infection rates distributed globally?

is higher TB incidence associated with higher household infection?

how has household infection changed over time?

which countries have the highest TB data gaps?

```{r}
library(tidyverse)
```

```{r}
library(tidyverse)
library(maps)

# 1. Get the world map data
world_map <- map_data("world")

# 2. Prepare your data (Latest year: 2024)
ltbi_map_data <- ltbi_data %>%
  filter(year == 2024) %>%
  # Fix country names to match library(maps)
  mutate(country = case_when(
    country == "United States" ~ "USA",
    country == "United Kingdom" ~ "UK",
    country == "Democratic Republic of the Congo" ~ "Democratic Republic of the Congo",
    country == "Congo" ~ "Republic of Congo",
    TRUE ~ country
  ))

# 3. Join your data to the map coordinates
map_data_joined <- left_join(world_map, ltbi_map_data, by = c("region" = "country"))

# 4. Plot the map using coord_quickmap() instead
ggplot(map_data_joined, aes(x = long, y = lat, group = group, fill = Preventive_Tx_Pct)) +
  geom_polygon(color = "white", size = 0.1) +
  
  # This replaces coord_map() and does NOT need mapproj
  coord_quickmap() + 
  
  scale_fill_viridis_c(
    option = "plasma", 
    name = "Coverage (%)", 
    na.value = "lightgrey", 
    direction = -1
  ) +
  labs(
    title = "Global TB Preventive Treatment Coverage (2024)",
    subtitle = "Map created without mapproj",
    x = "", y = ""
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
```

```{r}
library(tidyverse)
library(maps)
library(scales)

# 1. Load Data
df <- TB_10_years

# 2. Filter for 2024 Data
df_2024 <- df %>%
  filter(year == 2024)

# GLOBAL ANALYSIS (Matching the Text)

analysis_2024 <- df_2024 %>%
  summarise(
    # 1. Estimated Household Contacts (Matches "14 million")
    Global_Estimated_Contacts = sum(Contacts_best, na.rm = TRUE),
    
    # 2. People Provided TPT (Matches "3.5 million")
    # Calculated as Estimated * Coverage %
    Global_TPT_Total = sum(Contacts_best * (Preventive_Tx_Pct / 100), na.rm = TRUE),
    
    # 3. Children <5 Eligible & on TPT
    Global_Kids_Eligible = sum(Preventive_Tx_Eligible, na.rm = TRUE),
    Global_Kids_TPT = sum(Preventive_Tx_Eligible * (Preventive_Tx_Kids_Pct / 100), na.rm = TRUE)
  ) %>%
  mutate(
    Global_Coverage_Pct = (Global_TPT_Total / Global_Estimated_Contacts) * 100
  )

print(" GLOBAL TB PREVENTIVE TREATMENT HIGHLIGHTS (2024)")
print(analysis_2024)

# Prepare Map Data
world_map <- map_data("world") %>%
  rename(country = region) %>%
  # Fix common country name mismatches to improve data joining
  mutate(country = case_when(
    country == "USA" ~ "United States of America",
    country == "UK" ~ "United Kingdom",
    country == "Democratic Republic of the Congo" ~ "Democratic Republic of the Congo",
    country == "Republic of Congo" ~ "Congo",
    TRUE ~ country
  ))

# Join Data with Map
map_data_joined <- left_join(world_map, df_2024, by = "country")

# Plot Fig 3.8
p_map <- ggplot(map_data_joined, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = Preventive_Tx_Pct), color = "white", size = 0.1) +
  scale_fill_gradientn(
    colors = c(
    "#A50026", "#D73027", "#F46D43", "#FDAE61", "#FEE08B", 
    "#FFFFBF", 
    "#D9EF8B", "#A6D96A", "#66BD63", "#1A9850", "#006837"
  ),
    na.value = "grey90",
    name = "Coverage (%)",
    limits = c(0, 100),
    labels = label_percent(scale = 1)
  ) +
  labs(
    title = "TPT Coverage among Estimated Household Contacts (2024)",
    subtitle = "Percentage of estimated contacts provided with TB preventive treatment",
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2, "cm"),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  coord_fixed(1.3)

print(p_map)
```

```{r}
library(tidyverse)
library(maps)
library(scales)

# 1. Load Data
df <- TB_10_years

# Map of TB Incidence Rates (2024)
# "Estimated new cases per 100,000 population"

df_2024 <- df %>% filter(year == 2024)

world_map <- map_data("world") %>%
  rename(country = region) %>%
  mutate(country = case_when(
    country == "USA" ~ "United States of America",
    country == "UK" ~ "United Kingdom",
    country == "Democratic Republic of the Congo" ~ "Democratic Republic of the Congo",
    country == "Republic of Congo" ~ "Congo",
    TRUE ~ country
  ))

map_data_joined <- left_join(world_map, df_2024, by = "country")

p_map_inc <- ggplot(map_data_joined, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = e_inc_100k), color = "white", size = 0.1) +
  # Using 'viridis' option 'inferno' or 'magma' for high contrast
  scale_fill_viridis_c(
    option = "magma", 
    direction = -1, # Darker colors for higher incidence
    trans = "log10", # Log scale helps visualize differences better
    name = "Incidence\n(per 100k)",
    na.value = "grey90"
  ) +
  labs(
    title = "Global TB Incidence Rates (2024)",
    caption = "Source: TB_10_years.csv (e_inc_100k)"
  ) +
  theme_void() +
  theme(legend.position = "bottom", legend.key.width = unit(2, "cm")) +
  coord_fixed(1.3)

print(p_map_inc)
```

```{r}
library(tidyverse)
library(scales)

# 1. Load Data
df <- TB_10_years

# 2. Data Processing
# We need to calculate the absolute numbers from the percentages and denominators.
plot_data <- df %>%
  mutate(
    # A. Calculate Number of Children (<5) on TPT
    # 'Preventive_Tx_Eligible' is typically the number of eligible children <5
    # 'Preventive_Tx_Kids_Pct' is the coverage % for this group
    TPT_Kids = Preventive_Tx_Eligible * (Preventive_Tx_Kids_Pct / 100),
    
    # B. Calculate Total Household Contacts on TPT
    # 'Contacts_best' is the number of contacts evaluated (denominator)
    # 'Preventive_Tx_Pct' is the overall contact coverage %
    TPT_Total_Contacts = Contacts_best * (Preventive_Tx_Pct / 100)
  ) %>%
  # Aggregate global totals by year
  group_by(year) %>%
  summarise(
    TPT_Kids_Global = sum(TPT_Kids, na.rm = TRUE),
    TPT_Total_Global = sum(TPT_Total_Contacts, na.rm = TRUE)
  ) %>%
  mutate(
    # C. Derive Adults/Older Contacts (>=5) on TPT
    # Subtract Kids from the Total. Ensure no negative values.
    TPT_Adults_Global = pmax(0, TPT_Total_Global - TPT_Kids_Global)
  ) %>%
  # Reshape data for plotting (Long format)
  select(year, TPT_Kids_Global, TPT_Adults_Global) %>%
  pivot_longer(
    cols = c("TPT_Kids_Global", "TPT_Adults_Global"),
    names_to = "Category",
    values_to = "Number_on_TPT"
  ) %>%
  # Rename categories for the legend
  mutate(
    Category = case_when(
      Category == "TPT_Kids_Global" ~ "Children aged <5 years",
      Category == "TPT_Adults_Global" ~ "Household contacts aged ≥5 years"
    ),
    # Set factor levels to control stacking order (Adults on bottom, Kids on top)
    Category = factor(Category, levels = c("Children aged <5 years", "Household contacts aged ≥5 years"))
  )

# 3. Create the Plot
# Modeled after WHO Global TB Report Fig 3.1 styles
ggplot(plot_data, aes(x = year, y = Number_on_TPT, fill = Category)) +
  geom_col(width = 0.7) +
  # Use colors similar to the WHO report (Orange for Kids, Light Blue for Adults)
  scale_fill_manual(values = c(
    "Children aged <5 years" = "#E69F00",       # Orange
    "Household contacts aged ≥5 years" = "#56B4E9" # Light Blue
  )) +
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.1))
  ) +
  scale_x_continuous(breaks = 2015:2024) +
  labs(
    title = "Global Number of People Provided with TB Preventive Treatment",
    subtitle = "Household Contacts",
    x = "Year",
    y = "Number of people (Millions)",
    fill = "Target Group: ",
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.major.x = element_blank(),
    plot.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 11)
  )
```

```{r}
library(tidyverse)
library(scales)

# Load and Prep Data
df <- TB_10_years 
df_clean <- df %>%
  mutate(TPT_Contacts_Num = Contacts_best * Preventive_Tx_Pct / 100)

global_trends <- df_clean %>%
  filter(year >= 2015) %>%
  group_by(year) %>%
  summarise(
    Total_TPT_Contacts = sum(TPT_Contacts_Num, na.rm = TRUE),
    Total_Contacts_Eligible = sum(Contacts_best, na.rm = TRUE),
    Avg_Child_Coverage = mean(Preventive_Tx_Kids_Pct, na.rm = TRUE)
  ) %>%
  mutate(Contact_Coverage = (Total_TPT_Contacts / Total_Contacts_Eligible) * 100)

# Generate Plot
p <- ggplot(global_trends, aes(x = year)) +
  geom_line(aes(y = Contact_Coverage, color = "Household Contacts (All Ages)"), size = 1.2) +
  geom_point(aes(y = Contact_Coverage, color = "Household Contacts (All Ages)"), size = 3) +
  geom_line(aes(y = Avg_Child_Coverage, color = "Children (<5 years)"), linetype = "dashed", size = 1.2) +
  geom_point(aes(y = Avg_Child_Coverage, color = "Children (<5 years)"), shape = 15, size = 3) +
  scale_x_continuous(breaks = 2015:2024) +
  scale_y_continuous(limits = c(0, 100), labels = label_percent(scale = 1)) +
  labs(
    title = "Trends in TB Preventive Treatment Coverage",
    subtitle = "Comparison of Overall Contacts vs. Children (<5y)",
    y = "Coverage (%)",
    x = "Year",
    color = "Target Group: "
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

print(p)
```

```{r}
library(tidyverse)
library(scales)

# 1. Prepare the Data
gap_analysis <- TB_10_years %>%
  filter(year == latest_year) %>%
  filter(!is.na(Preventive_Tx_Pct) & !is.na(Contacts_best))

# 2. Define Dynamic Thresholds
# Burden Threshold: Top 10% of countries with the most contacts
burden_threshold <- quantile(gap_analysis$Contacts_best, 0.90) 

# Coverage Threshold: Less than 50% coverage (Performance Gap)
coverage_threshold <- 50

# 3. Create a Flag for High Risk Countries
gap_analysis <- gap_analysis %>%
  mutate(
    Is_High_Risk = if_else(Contacts_best >= burden_threshold & Preventive_Tx_Pct < coverage_threshold, 
                           "High Risk (High Burden, Low Coverage)", 
                           "Other")
  )

# 4. Plot
ggplot(gap_analysis, aes(x = Contacts_best, y = Preventive_Tx_Pct)) +
  # Plot "Other" points first (grey)
  geom_point(data = subset(gap_analysis, Is_High_Risk == "Other"), 
             alpha = 0.5, color = "darkgrey", size = 2) +
  
  # Plot "High Risk" points on top (Dynamic Color)
  geom_point(data = subset(gap_analysis, Is_High_Risk != "Other"), 
             aes(color = Is_High_Risk), size = 3) +
  
  # Add labels ONLY for the High Risk countries
  geom_text(data = subset(gap_analysis, Is_High_Risk != "Other"), 
            aes(label = country), vjust = -1, size = 3, fontface = "bold") +

  # Formatting
  scale_x_log10(labels = scales::comma) + 
  scale_y_continuous(limits = c(0, 100)) +
  scale_color_manual(values = c("High Risk (High Burden, Low Coverage)" = "firebrick")) +
  
  labs(
    title = "The Gap: Burden vs. Treatment Performance",
    subtitle = paste0("Highlighted: Top 10% Burden (> ", comma(burden_threshold), " contacts) AND Coverage < 50%"),
    x = "Household Contacts (Log Scale)",
    y = "Preventive Treatment Coverage (%)",
    color = "Country Status"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")
```
