---
title: "TB_R_course"
format: html
---

WHO 2025 data on Tuberculosis.

In this script, we will be working with the following dataset:

"***WHO TB incidence estimates disaggregated by age group, sex and risk factor \[\>0.5Mb\]***"

Link:

<https://www.who.int/teams/global-programme-on-tuberculosis-and-lung-health/data#csv_files>

Important: It may look like R only downloaded the data for countries from A to B.

But that is just a visualization thing in order to save memory.

------------------------------------------------------------------------

**Note to self - add this in all code chunks when wrapping up:**

```{r}
#| echo: true
#| eval: true
```

**Loading relevant libraries:**

```{r}
library(tidyverse) #The main package of the course. Allows us to load nifty table-like structures. A bit similar to Pandas from Python. 
library(dplyr)     #Allows us to make the |> pipelines when manipulating data. 
library(stringr)   #Allows for string manipulation. Can be good when you e.g. want to rename stuff.
library(ggplot2)   #For making cool plots. 
library(forcats)   #fct_reorder() can be used to reorder certain names/ strings. 
```

**Loading data:**

WHO TB incidence estimates disaggregated by age group, sex and risk factor \[\>0.5Mb\]

```{r}
#Loading age and sex and risk group data (2024 only): 

data_folder <- "../Data"
data_file   <- file.path(data_folder, "TB_age_sex.csv")
data_url    <- "https://extranet.who.int/tme/generateCSV.asp?ds=estimates_age_sex"


####################################

# Ensure Data folder exists

if (!dir.exists(data_folder)) {
  message("Creating Data folder…")
  dir.create(data_folder)
}

####################################

# Load from disk OR download & save it through the link above: 

if (file.exists(data_file)) {
  
  message("Loading TB_age_sex from local file…")
  TB_age_sex <- read_csv(
    file = data_file,
    show_col_types = FALSE
  )
  
} else {
  
  message("Local file not found. Downloading from WHO's website…")
  TB_age_sex <- read_csv(
    file = data_url,
    show_col_types = FALSE
  )
  
  message("Saving dataset to Data/TB_age_sex.csv…")
  write_csv(
    x = TB_age_sex,
    file = data_file
  )
}

#Display the data: 
TB_age_sex

```

(Quick note: I have included the use of *if-statements*, which might be considered a bit outside the curriculum. I only do it in order to make a flexible code that ensures that the data is only downloaded online if it has not already been downloaded by the user before (first time running the code) - in order not to waste computational resources, as Leon mentioned that there were some memory problems on the cluster.

**Comments about the data:**

Shows estimated TB cases for different countries.

This particular dataset only contains data from **2024**.

Shows metadata about **age** groups, **sex**, and **risk factors** (e.g., HIV).

Furthermore, it shows the best estimate of TB cases ("**best**" column) a high bound of that estimate ("**hi**" column), and a lower bound of that estimate ("**lo**" column).

### **Data exploration and cleaning:**

```{r}
#Summary statistics

#Note: The output is not very pretty. Use the code block below. 

#summary(TB_age_sex)

```

```{r}
#Some summary statistics: 


TB_age_sex |> 
  summarise(
    n_rows = n(),
    n_countries = n_distinct(country),
    n_years = n_distinct(year),
    n_sex_categories = n_distinct(sex),
    min_year = min(year, na.rm = TRUE),
    max_year = max(year, na.rm = TRUE),
    total_cases_best = sum(best, na.rm = TRUE),
    total_cases_lo = sum(lo, na.rm = TRUE),
    total_cases_hi = sum(hi, na.rm = TRUE)
  )

```

9031 rows, 182 countries, 3 sex categories (male, female, and aggregated (aka. "both")), a total estimate of 71,744,072 TB cases (**\~72 million TB cases in 2024**).

```{r}
#All unique values in the "meaure" column
unique(TB_age_sex$measure)
```

```{r}
#All unique values in the "unit" column
unique(TB_age_sex$unit)
```

"Unit = num" and "Measure = inc" mean that it is the number of TB incidences that year.

**Renaming columns in the data:**

```{r}
#Adjusting some of the column names, to make them more intuitive. 
TB_age_sex <- TB_age_sex |> 
  rename(
    iso_code = iso3,
    TB_cases_best = best,
    TB_cases_min = lo,
    TB_cases_max = hi
  )
```

```{r}
TB_age_sex
```

Note: The age group sometimes contains info like "15plus" instead of e.g. "15-100" or "15+".

Changing the sex: f, m, a to female, male, both (aggregated)

```{r}
#The 'case_when()' function is used to change the values. 
#It works as a replace function. 

TB_age_sex <- TB_age_sex |> 
  mutate( 
    sex = case_when( 
      sex == "m" ~ "Male", 
      sex == "f" ~ "Female", 
      sex == "a" ~ "Both", 
    ) 
  ) 

print(TB_age_sex)
```

```{r}
#Sanity/ quality check: 
print( unique(TB_age_sex$sex) ) 

#Printing the unique values from the "sex" column
#It should only return Male, Female and Both. 

```

Arguably, the columns for "iso2", "iso_code", iso_numeric", "measure" and "unit" don't present any particularly valuable info, so we will just remove those columns.

**Remove irrelevant columns:**

```{r}
TB_age_sex <- TB_age_sex |>
  select(-"iso2", -"iso_code", -"iso_numeric", -"measure", -"unit") #The minus sign tells R to NOT select those columns. 

```

```{r}
print(TB_age_sex)
```

**All of the risk factors in the data:**

```{r}
unique(TB_age_sex$risk_factor)
```

all = all risk factors combined.

alc = alcoholism

smk = smoking

dia = diabetes

hiv = HIV infected

und = undernourishment

```{r}
TB_age_sex <- TB_age_sex |> 
  mutate( 
    risk_factor = case_when( 
      risk_factor == "all" ~ "all", #stay the way it is. 
      risk_factor == "alc" ~ "alcoholism", 
      risk_factor == "smk" ~ "smoking", 
      risk_factor == "dia" ~ "diabetes", 
      risk_factor == "hiv" ~ "HIV", #capital letters
      risk_factor == "und" ~ "undernourishment" 
    ) 
  ) 
```

Sanity check:

```{r}
unique(TB_age_sex$risk_factor)
```

Last adjustments to the data would be correcting the "age_group" so e.g. "15plus" becomes "15+".

```{r}
unique(TB_age_sex$age_group)
```

```{r}
TB_age_sex <- TB_age_sex |>
  mutate(age_group = str_replace(age_group, "plus", "+")) #str_replace is from 'stringr'
```

```{r}
#Sanity check: 
unique(TB_age_sex$age_group)
```

**Checking if there are any NA values in the data:**

```{r}
#Checking for NA values throughout entire dataset: 
any(is.na(TB_age_sex))
```

Could also have used this code to inspect each of the columns individually:

```{r}
TB_age_sex |>
  summarise(across(everything(), ~ any(is.na(.))))
```

As there are no further NA values, in the remaining, cleaned data, it seems fair to conclude the cleaning of the data here.

Finally, let's sample only the data from Denmark, just to get some insights:

```{r}
TB_age_sex |>
  filter(country == "Denmark", sex == "Both")
```

It is worth noting that (at least for Denmark) the risk factors are only reported on the "sex = Both" grouped data.

Based on the tibble above, it becomes clear that 'risk factor = all' might not be what we originally thought:

```{r}
#Understanding the "all" risk label: 
TB_age_sex |>
  filter(country == "Denmark", risk_factor != "all") |> #The ones that are not labelled "all". 
  summarise(sum_TB = sum(TB_cases_best))
```

```{r}
TB_age_sex |>
  filter(country == "Denmark", risk_factor == "all") |> #The ones that ARE labelled "all". 
  summarise(sum_TB = sum(TB_cases_best))
```

'Risk factor = all' is not specified anywhere in the WHO report.

Therefore, based on the analysis above, it seems safe to draw the conclusion that 'risk factor = all' actually means 'risk factor = no risk factor'.

We will therefore rename the value accordingly:

```{r}
TB_age_sex <- TB_age_sex |>
  mutate(
    risk_factor = case_when(
      risk_factor == "all" ~ "no risk factor",
      TRUE ~ risk_factor        # keep all other values as they are
    )
  )

```

This was a nice case of how critical thinking can help out when official descriptions of the dataset fall short.

```{r}
TB_age_sex
```

------------------------------------------------------------------------

As one of the last steps, we wanna merge some of the data from the other datasets onto this dataset.

Specifically, we would like to obtain the information regarding the total population of each country, and merge it into our tibble.

We can use the '***WHO TB burden estimates \[\>1Mb\]***' dataset to obtain the information about the population.

Note: This dataset contains data from years other than 2024, so we can either filter those years away, or we can count for this in the way we merge.

**Loading additional data in order to merge:**

```{r}

#data_folder <- "../Data" #Was already defined 
data_file   <- file.path(data_folder, "TB_burden.csv")
data_url    <- "https://extranet.who.int/tme/generateCSV.asp?ds=estimates"


####################################

# Ensure Data folder exists

if (!dir.exists(data_folder)) {
  message("Creating Data folder…")
  dir.create(data_folder)
}

####################################

# Load from disk OR download & save it through the link above: 

if (file.exists(data_file)) {
  
  message("Loading TB_burden from local file…")
  TB_burden <- read_csv(
    file = data_file,
    show_col_types = FALSE
  )
  
} else {
  
  message("Local file not found. Downloading from WHO's website…")
  TB_burden <- read_csv(
    file = data_url,
    show_col_types = FALSE
  )
  
  message("Saving dataset to Data/TB_age_sex.csv…")
  write_csv(
    x = TB_burden,
    file = data_file
  )
}

#Display the data: 
TB_burden
```

```{r}
#Making dataset containing all population data (2024) for every country. 
population_data_2024 <- TB_burden |>
  select(country, e_pop_num, year) |>
  filter(year == 2024) |>
  rename(population_size = e_pop_num)

population_data_2024
```

**Joining population data to main data:**

```{r}
TB_age_sex <- left_join(TB_age_sex, population_data_2024, by = c("country", "year"))
TB_age_sex
```

Note: The population size is kept constant in all rows, but e.g., Afghanistan has several rows for e.g. different age groups, where the TB cases varies - so TB varies, but population size is constant for each row (country specific).

**Data augmentation:**

Lastly, we can make a column which shows the amount of TB cases pr. 100k citizens in the country. This normalization will help make the TB cases more comparable for all countries, and makes the comparison more independent on the population size.

```{r}
#Regarding scientific number notation (3.67e5):

options(scipen = 30) #This increases the amount of digits before switching to,
#scientific notation. 

#30 is just used as a high number. 
```

```{r}
TB_age_sex <- TB_age_sex |>
  group_by(country) |>
  
  #Getting the total sum of TB cases for every country
  mutate( 
    total_TB_cases_best = sum(TB_cases_best), 
    total_TB_cases_min = sum(TB_cases_min), 
    total_TB_cases_max = sum(TB_cases_max)
    ) |> 
  
      #For each row (specific age, sex and risk-factor group), 
      #calculate the pr. 100k amount of cases
  mutate( 
        TB_cases_pr_100k_best = TB_cases_best/population_size*10^5,
        TB_cases_pr_100k_min = TB_cases_min/population_size*10^5,
        TB_cases_pr_100k_max = TB_cases_max/population_size*10^5,
        
        #For each each country, calculate the summed pr. 100k amount of cases
        total_TB_cases_pr_100k_best = total_TB_cases_best/population_size*10^5,
        total_TB_cases_pr_100k_min = total_TB_cases_min/population_size*10^5, 
        total_TB_cases_pr_100k_max = total_TB_cases_max/population_size*10^5)
  
```

```{r}
TB_age_sex
```

Final (sanity) check if we have any NA values:

```{r}
TB_age_sex |>
  summarise(across(everything(), ~ any(is.na(.))))
```

OK, we are all clear B)))

Final check - we gotta check if there is an equal amount of observations for every country:

```{r}
TB_age_sex |>
  group_by(country) |>
  summarise(row_count = n())
```

```{r}
TB_age_sex |>
  group_by(country) |>
  summarise(row_count = n()) |>
  distinct(row_count)
```

We now know that every country has around 45-50 rows. This degree of difference is manageable and should not disturb the overall analysis.

That wraps up all of the data cleaning (for real, this time!)

# **Data visualization:**

The data:

```{r}
TB_age_sex
```

Initial **summary statistics** for the data:

```{r}
TB_age_sex |> 
  summarise(
    n_countries = n_distinct(country),
    average_total_TB_pr_100k = mean(total_TB_cases_pr_100k_best, na.rm = TRUE),
    min_total_TB_pr_100k = min(total_TB_cases_pr_100k_best, na.rm = TRUE),
    max_total_TB_pr_100k = max(total_TB_cases_pr_100k_best, na.rm = TRUE),
    std_total_TB_pr_100k = sd(total_TB_cases_pr_100k_best, na.rm = TRUE)
  )
```

**Top 10 countries with most TB cases:**

```{r}
top_10_countries <- TB_age_sex |>
  group_by(country) |>
  summarise(total_TB = first(total_TB_cases_best)) |>
  arrange(desc(total_TB)) |>
  slice_head(n = 10) |> 
  pull(country)

print(top_10_countries)
```

```{r}
# Filter the data
TB_age_sex |> 
  filter(country %in% top_10_countries)

```

```{r}
TB_age_sex |>
  filter(country %in% top_10_countries) |>
  group_by(country)
```

```{r}
TB_summary <- TB_age_sex |>
  filter(country %in% top_10_countries) |>
  group_by(country) |>
  summarise(
    mean_best = sum(TB_cases_best, na.rm = TRUE), #Sum of TB cases for this country 
    min_val  = sum(TB_cases_min, na.rm = TRUE),
    max_val  = sum(TB_cases_max, na.rm = TRUE),
    
    #pr. 100k values
    mean_best_100k = first(total_TB_cases_pr_100k_best), #Ensures only 1 row
    min_val_100k  = first(total_TB_cases_pr_100k_min),
    max_val_100k  = first(total_TB_cases_pr_100k_max),
  )

TB_summary
```

```{r}
options(scipen = 0)

ggplot(TB_summary, aes(x = mean_best, y = country)) +
  geom_point(size = 3, color = "orange") +
  geom_errorbarh(aes(xmin = min_val, xmax = max_val), height = 0.2) +
  labs(
    x = "TB cases\n(Best estimate with min/max)",
    y = "Country",
    title = "Top 10 Countries - Total TB cases, with error bars"
  ) +
  theme_minimal()

```

**The 10 countries with the highest amount of TB cases (best estimate) pr. 100k citizens:**

It gets extremely cluttered if we try to visualize data for every country. But we are also mostly interested in the countries that have the most TB cases.

```{r}
#Only the top 10 countries: 
TB_age_sex |>
  group_by(country) |>
  summarise(
    #Note: We only want 1 value for each country, so we just use mean().
    #Even tho the value is constant and country-specific, 
    #and therefore spans several rows for each country.
    #So it won't really matter that we use mean(). 
    total_TB_cases_pr_100k_best = mean(total_TB_cases_pr_100k_best, na.rm = TRUE),
    population_size_pr_million = mean(population_size)*10^-6
    ) |>
  arrange(desc(total_TB_cases_pr_100k_best)) |>
  slice_head(n = 10) #Picking the top 10. 
```

```{r}
#Making an object for storing the top 10 countries with most TB cases: 
top_10_countries_100k <- TB_age_sex |>
  group_by(country) |>
  summarise(
    total_TB_cases_pr_100k_best = mean(total_TB_cases_pr_100k_best, na.rm = TRUE),
    population_size_pr_million = mean(population_size)*10^-6
    ) |>
  arrange(desc(total_TB_cases_pr_100k_best)) |>
  slice_head(n = 10) |>
  pull(country)
```

```{r}
# Filter the data
TB_top <- TB_age_sex |> 
  filter(country %in% top_10_countries_100k)

```

**Box plot of countries with the top 10 most TB cases pr. 100k:**

```{r}
# Boxplot
ggplot(TB_top, aes(y = country, x = TB_cases_best)) +
  geom_boxplot(alpha = 0.7, fill = "orange") +
  labs(x = "TB cases\n(Separated based on different metadata rows)", y = "Country") +
  theme_minimal()
```

Note: This boxplot is not really ideal. As several different datapoints just represent different rows.

As 1 dot represents 1 row, that means 'the number of age 15+ people with HIV and TB'.

**Scatter plot with error bars - Top 10 countries with most TB:**

```{r}
#Making a tibble with only the TB cases pr. 100k for the top 10 countries. 
TB_summary <- TB_top |>
  group_by(country) |>
  summarise(
    mean_best = mean(total_TB_cases_pr_100k_best, na.rm = TRUE), #Ensures only 1 row. 
    min_val  = min(total_TB_cases_pr_100k_min,  na.rm = TRUE),
    max_val  = max(total_TB_cases_pr_100k_max,  na.rm = TRUE)
  )

#Again, note that the values for the countries are constant, so it doesn't really
#matter if we use max(), min() or mean() to extract them. 
```

```{r}
ggplot(TB_summary, aes(x = mean_best, y = country)) +
  geom_point(size = 3, color = "orange") +
  geom_errorbarh(aes(xmin = min_val, xmax = max_val), height = 0.2) +
  labs(
    x = "TB cases per 100k\n(Best estimate with min/max)",
    y = "Country",
    title = "Top 10 Countries — TB Cases per 100k with error bars"
  ) +
  theme_minimal()
```

**Scatter plot with error bars - Countries with above 1k TB case pr. 100k:**

We can't simply plot all of the countries, as this would be too cluttered.

But perhaps we are also not really interested in plotting the countries with a few TB cases.

Therefore, we will focus on only plotting countries where the best estimate of TB cases pr. 100k citizens equals or exceeds 1!

```{r}
TB_summary <- TB_age_sex |> #Updating this tibble to make it cover all countries
  group_by(country) |>
  summarise(
    mean_best = mean(total_TB_cases_pr_100k_best, na.rm = TRUE), #Ensures only 1 row. 
    min_val  = min(total_TB_cases_pr_100k_min,  na.rm = TRUE),
    max_val  = max(total_TB_cases_pr_100k_max,  na.rm = TRUE)
  ) |>
  filter(mean_best >= 1000) #Above or equal 1k out of 100k

TB_summary
```

```{r}
ggplot(TB_summary, aes(x = mean_best, y = country)) +
  geom_point(size = 3, color = "orange") +
  geom_errorbarh(aes(xmin = min_val, xmax = max_val), height = 0.2) +
  labs(
    x = "TB cases per 100k\n(Best estimate with min/max)",
    y = "Country",
    title = "TB Cases per 100k with error bars\n(Only countries with 1k <= TB case pr. 100k)"
  ) +
  theme_minimal()
```

```{r}
#ORDERED version of the plot above:
ggplot(
  TB_summary |> arrange(mean_best),  # order by mean
  aes(x = mean_best, y = fct_reorder(country, mean_best))
) +
  geom_errorbarh(aes(xmin = min_val, xmax = max_val), height = 0.2) +
  geom_point(size = 1.5, color = "orange") +
  labs(
    x = "TB cases per 100k\n(Best estimate with min/max)",
    y = "Country",
    title = "TB Cases per 100k with error bars\n(Only countries with 1k <= TB case pr. 100k)"
  ) +
  #theme(axis.text.y = element_text(size = 10, margin = margin(r = 5))) +
  theme(
  axis.text.y = element_text(size = 10, margin = margin(r = 6)),
  axis.ticks.y = element_line(),
  panel.grid.major.y = element_blank()
) +
  theme_minimal()
```

**Box plot - TB cases for sexes:**

```{r}
#Boxplot - Sexes and TB cases | Only top 10 most TB infected countries:

ggplot(TB_age_sex,
       aes(y = TB_cases_pr_100k_best, x = sex)) + 
  geom_boxplot(alpha = 1) +
  theme(legend.position = "none")
```

The stark contrast between infection and low-infection countries skews the box plots. It is therefore important to focus more concretely on some of the high-infection countries.

```{r}
#Top 10 countries, amount of TB cases pr. 100k, segmented into sex: 
TB_summary <- TB_age_sex |>
  group_by(sex, country) |>
  summarise(summed_TB_cases_pr_100k_min = sum(TB_cases_pr_100k_min),
            summed_TB_cases_pr_100k_best = sum(TB_cases_pr_100k_best),
            summed_TB_cases_pr_100k_max = sum(TB_cases_pr_100k_max),
            ) |> 
  filter(country %in% top_10_countries_100k)


TB_summary
```

```{r}
#Boxplot - Sex-divided amount of TB cases (only for top 10 most infected countries):

ggplot(TB_summary,
       aes(y = summed_TB_cases_pr_100k_best, x = sex)) + 
  geom_boxplot(alpha = 1, fill = "orange") +
  theme(legend.position = "none") +

  labs(
    x = "Sex",
    y = "Summed amount of TB cases per 100k for each sex for country\n(Best estimate)",
    title = "Sex-divided amount of TB cases (Top 10 most infected countries)"
  )

```

```{r}
#Scatter plot for TB cases for different sexes 
#in top 10 most infected countries (per capita, 100k)

ggplot(TB_summary, aes(x = summed_TB_cases_pr_100k_best, y = country, color = sex)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbarh(
    aes(xmin = summed_TB_cases_pr_100k_min, xmax = summed_TB_cases_pr_100k_max),
    position = position_dodge(width = 0.5),
    height = 0.4
  ) +
  labs(
    x = "TB cases per 100k\n(Best estimate with min/max)",
    y = "Country",
    title = "TB cases pr. 100k by sex\n(Countries with top 10 most TB cases)"
  ) +
  theme_minimal()

```

Oddly, the "both" group tends to break out of the correlation for "male" and "female", in some cases.

**Bar chart for TB cases in different age groups:**

```{r}
unique(TB_age_sex$age_group)
```

Due to the overlap, it is not possible to do a proper histogram. But a bar chart can be done.

```{r}
TB_age_sex
```

```{r}
TB_age_sex |>
  group_by(age_group) |>
  summarise(total_TB_age_grouped = sum(TB_cases_pr_100k_best, na.rm = TRUE)) |>
  ggplot(aes(x = age_group, y = total_TB_age_grouped)) +
  geom_col(fill = "orange") +
  labs(
    x = "Age group",
    y = "Total TB cases per 100k",
    title = "Summed TB cases per age group"
  ) +
  theme_minimal()
```

```{r}
#Same bar plot as above, but with more sensible sorting of x-axis: 

TB_age_sex |>
  group_by(age_group) |>
  summarise(total_TB = sum(TB_cases_pr_100k_best, na.rm = TRUE)) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)  # ensures "all" goes last
  ) |>
  ggplot(aes(x = fct_reorder(age_group, age_lower), y = total_TB)) +
  geom_col(fill = "orange") +
  labs(
    x = "Age group",
    y = "Total TB cases per 100k",
    title = "Summed TB cases per age group\n(Corrected x-axis order)"
  ) +
  theme_minimal()

```

15+, 18+ and 'all' might not be as relevant to have in the plot.

It looks a little bit like 0-14 could be the sum of 0-4 and 5-14 and 10-14 and 5-9:

```{r}
TB_age_sex |>
  select(country,age_group, TB_cases_pr_100k_best) |>
  group_by(country, age_group) |>
  summarise(age_TB_sum = sum(TB_cases_pr_100k_best)) |>
  filter(age_group %in% c("0-4","10-14","0-14", "5-9", "5-14"))
```

However, as we can see above, 0-14 is not merely the sum of 0-4 and 5-9 and 5-14 and 10-14.

```{r}
#Removing 15+, etc. from the barplot: 

TB_age_sex |>
  filter(!age_group %in% c("0-14","15+", "18+", "all")) |> #Without these 4 groups. 
  group_by(age_group) |>
  summarise(total_TB = sum(TB_cases_pr_100k_best, na.rm = TRUE)) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)  # just in case
  ) |>
  ggplot(aes(x = fct_reorder(age_group, age_lower), y = total_TB)) +
  geom_col(fill = "orange") +
  labs(
    x = "Age group",
    y = "Total TB cases per 100k",
    title = "Summed TB cases per age group\n(Corrected x-axis order)"
  ) +
  theme_minimal()

```

Notably, it is not surprising that 20-24 is lower than the flanking bars, as it spans a shorter set of years and therefore defines a smaller group.

Kids (younger than 15) generally appear to be less infected. This could be explained by the TB vaccine, namely BCG, being more protective in kids.

Source:

<https://www.who.int/teams/global-programme-on-tuberculosis-and-lung-health/research-innovation/vaccines#:~:text=Neonatal%20BCG%20vaccination%20offers%20partial,the%20majority%20of%20TB%20transmission.>

```{r}
#Making a version of the bar chart with error bars. 
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all", "0-14")) |> 
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_pr_100k_best, na.rm = TRUE),
    total_min  = sum(TB_cases_pr_100k_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_pr_100k_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  ) |>
  ggplot(aes(x = fct_reorder(age_group, age_lower), y = total_best)) +
  
  # --- BAR ---
  geom_col(fill = "orange") +
  
  # --- ERROR BARS ---
  geom_errorbar(
    aes(ymin = total_min, ymax = total_max),
    width = 0.2
  ) +
  
  labs(
    x = "Age group",
    y = "Total TB cases per 100k",
    title = "Summed TB cases per age group - with min/max error bars"
  ) +
  theme_minimal()

```

Finally, we can also do a bar chart for the 10 most TB-infected countries:

```{r}
#Only for top 10 most TB-infected countries. 
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all","0-14")) |> #Remove the undesired age-groups
  filter(country %in% top_10_countries_100k) |> #Getting only the top 10 most infected countries
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_pr_100k_best, na.rm = TRUE),
    total_min  = sum(TB_cases_pr_100k_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_pr_100k_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  ) |>
  ggplot(aes(x = fct_reorder(age_group, age_lower), y = total_best)) +
  
  # --- BAR ---
  geom_col(fill = "orange") +
  
  # --- ERROR BARS ---
  geom_errorbar(
    aes(ymin = total_min, ymax = total_max),
    width = 0.2
  ) +
  
  labs(
    x = "Age group",
    y = "Total TB cases per 100k",
    title = "Summed TB cases per age group - with min/max error bars"
  ) +
  theme_minimal()
```

Again, it is notable that the problem with TB-infections is mainly observed in adults.

**Total TB cases - Whole world:**

```{r}
#Bar chart for worldwide TB cases, separated into age groups. 
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all", "0-14")) |> 
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_best, na.rm = TRUE),
    total_min  = sum(TB_cases_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  ) |>
  ggplot(aes(x = fct_reorder(age_group, age_lower), y = total_best)) +
  
  # --- BAR ---
  geom_col(fill = "orange") +
  
  # --- ERROR BARS ---
  geom_errorbar(
    aes(ymin = total_min, ymax = total_max),
    width = 0.2
  ) +
  
  labs(
    x = "Age group",
    y = "Total TB cases",
    title = "Total TB cases worldwide - with min/max error bars"
  ) +
  theme_minimal()
```

```{r}
#Bar chart for top 10 TB countries (pr. 100k), separated into age groups. 
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all", "0-14")) |> 
  filter(country %in% top_10_countries_100k) |>
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_best, na.rm = TRUE),
    total_min  = sum(TB_cases_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  ) |>
  ggplot(aes(x = fct_reorder(age_group, age_lower), y = total_best)) +
  
  # --- BAR ---
  geom_col(fill = "orange") +
  
  # --- ERROR BARS ---
  geom_errorbar(
    aes(ymin = total_min, ymax = total_max),
    width = 0.2
  ) +
  
  labs(
    x = "Age group",
    y = "Total TB cases",
    title = "Total TB cases worldwide - with min/max error bars"
  ) +
  theme_minimal()
```

Bruh, that is without a doubt the most pathetic set of error bars that I have ever laid eyes on.

```{r}
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all", "0-14")) |> 
  filter(country %in% top_10_countries_100k) |>
  group_by(age_group) |>
  summarise(
    total_min  = sum(TB_cases_min,  na.rm = TRUE),
  )
```

Note: None of the minimum values of the error bars is 0.

------------------------------------------------------------------------

It is important to understand that we are working with subsets of the whole data, as we are both working with a subset of the age groups and a subset of the countries (we are only working with the top 10 most infected).

```{r}
#Total amount of TB cases pr. 100k, summed - Whole dataset. 

TB_age_sex |>
  group_by(country) |>
  summarise(
    total_pr_100k = max(total_TB_cases_pr_100k_best)
  ) |>
  summarise(sum_of_TB_pr_100k_citizens = sum(total_pr_100k))
```

```{r}
TB_age_sex |>
  group_by(country) |>
  summarise(
    total_TB_cases = sum(TB_cases_best),
  ) |>
  summarise(total_TB_cases_worldwide = sum(total_TB_cases)) |> #total TB cases
  summarise(
    normalized = total_TB_cases_worldwide/(sum(TB_age_sex$population_size))*10^5)

  
```

------------------------------------------------------------------------

**TB cases relative to risk factors:**

```{r}
TB_age_sex |>
  filter(country %in% top_10_countries_100k)
```

We can examine the ratio of risk factor-infected relative to non-risk factor-infected.

```{r}
TB_age_sex |> 
  filter(country %in% top_10_countries_100k) |>
  group_by(country) |>
  summarise(
    non_risk = sum(TB_cases_best[risk_factor == "no risk factor"], na.rm = TRUE),
    risk     = sum(TB_cases_best[risk_factor != "no risk factor"], na.rm = TRUE),
    ratio    = risk / non_risk,
    ratio_percent    = risk / non_risk*100,
    population = first(population_size), #It is in multiple of the rows of the same num.
    #So we use first() to extract it from the first row. 
    
    risk_pr_100k = risk/population*10^5, 
    non_risk_pr_100k = non_risk/population*10^5
  ) |>
  arrange(desc(ratio))

```

**Bar plot - TB cases relative to risk factors:**

We can now make a plot of the TB cases, and also plot the risk factors (HIV, etc.) next to each bar. We will make a bar for each of the top 10 countries.

```{r}
#Making a tibble for the risk factors for each of the top 10 countries: 
TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  group_by(country, risk_factor) |>
  summarise(
    TB_cases_best = sum(TB_cases_best),
    TB_cases_min = sum(TB_cases_min),
    TB_cases_max = sum(TB_cases_max),
    population_size = first(population_size), #it is constant, and spans several rows. 
  )
```

```{r}
TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  group_by(country, risk_factor) |>
  summarise(
    TB_cases_best = sum(TB_cases_best),
    TB_cases_min = sum(TB_cases_min),
    TB_cases_max = sum(TB_cases_max),
    population_size = first(population_size), #it is constant, and spans several rows. 
  )|>
  ggplot(aes(x = country,
           y = TB_cases_best,
           fill = risk_factor)) +
  geom_col(position = "dodge") +
  labs(
    title = "TB cases by risk factor (Top 10 countries)",
    x = "Country",
    y = "TB cases (best estimate)",
    fill = "Risk factor"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

  
```

```{r}
TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  group_by(country, risk_factor) |>
  summarise(
    TB_cases_best = sum(TB_cases_best),
    TB_cases_min = sum(TB_cases_min),
    TB_cases_max = sum(TB_cases_max),
    population_size = first(population_size), #it is constant, and spans several rows. 
  )|>
  ggplot(aes(x = country,
           y = TB_cases_best/population_size*10^5,
           fill = risk_factor)) +
  geom_col(position = "dodge") +
  labs(
    title = "TB cases pr. 100k by risk factor (Top 10 countries)",
    x = "Country",
    y = "TB cases pr. 100k (best estimate)",
    fill = "Risk factor"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
#Version of 100k TB case bar chart without the non-risk cases. 

TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  group_by(country, risk_factor) |>
  filter(risk_factor != "no risk factor") |>
  summarise(
    TB_cases_best = sum(TB_cases_best),
    TB_cases_min = sum(TB_cases_min),
    TB_cases_max = sum(TB_cases_max),
    population_size = first(population_size), #it is constant, and spans several rows. 
  )|>
  ggplot(aes(x = country,
           y = TB_cases_best/population_size*10^5,
           fill = risk_factor)) +
  geom_col(position = "dodge") +
  labs(
    title = "TB cases pr. 100k by risk factor (Top 10 countries)\nNot including no risk factor label",
    x = "Country",
    y = "TB cases pr. 100k (best estimate)",
    fill = "Risk factor"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 55, hjust = 1))
```

----------------------------------------------

### **Experimental:** 

```{r}
#Arbitary baseline group: 
TB_age_sex |>
  filter(
    sex == "Both",
    age_group == "25-34",
    risk_factor == "no risk factor",
  )
```

**Multiple regression:**

```{r}
model <- TB_age_sex |>
  mutate(risk_factor = factor(risk_factor),
         sex = factor(sex),
         age_group = factor(age_group)) |>
  lm(TB_cases_best ~ risk_factor + age_group + sex, data = _)

summary(model)
```

**Heat map:**

```{r}
TB_age_sex |>
  ggplot(aes(x = age_group, y = risk_factor, fill = TB_cases_pr_100k_best)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(
    title = "TB cases pr. 100k by age group and risk factor",
    x = "Age group",
    y = "Risk factor",
    fill = "TB per 100k"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 55, hjust = 1)
  )

```

Transparent = NA value.

```{r}
TB_age_sex |>
  ggplot(aes(x = age_group, y = sex, fill = TB_cases_pr_100k_best)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(
    title = "TB cases pr. 100k by age group and risk factor",
    x = "Age group",
    y = "Sex",
    fill = "TB per 100k"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 55, hjust = 1)
  )

```

```{r}
TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  ggplot(aes(x = age_group, y = country, fill = TB_cases_pr_100k_best)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(
    title = "TB cases pr. 100k by age group and country",
    x = "Age group",
    y = "Country",
    fill = "TB per 100k"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 55, hjust = 1)
  )

```

```{r}
unique(TB_age_sex$age_group)
```

```{r}
library(dplyr)
library(tidyr)
library(forcats)
library(factoextra)

# 1. Filter to the relevant countries & clean
pca_data <- TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  mutate(
    risk_factor = factor(risk_factor),
    age_group   = factor(age_group)
  ) |>
  
  
  # 2. Compute TB per 100k for PCA
  mutate(TB_100k = TB_cases_best / population_size * 1e5) |>
  
  # 3. Aggregate: country × age_group × risk_factor
  group_by(country, age_group, risk_factor) |>
  summarise(TB_100k = sum(TB_100k), .groups = "drop") |>
  
  # 4. Wide format: rows = country, columns = age:risk combinations
  unite(feature, age_group, risk_factor, sep = "_") |>
  pivot_wider(
    names_from = feature,
    values_from = TB_100k,
    values_fill = 0   # missing combinations = 0
  )

# 5. Prepare matrix for PCA
pca_matrix <- pca_data |> 
  select(-country) |> 
  as.matrix()

rownames(pca_matrix) <- pca_data$country

# 6. Run PCA
pca_res <- prcomp(pca_matrix, scale. = TRUE)

# 7. PCA biplot using factoextra
fviz_pca_biplot(
  pca_res,
  repel = TRUE,
  col.var = "red",      # variable arrows
  col.ind = "black",    # country labels
  title = "PCA biplot of TB profiles (risk factor × age group)"
)
```

```{r}
pca_data
```

```{r}
library(dplyr)
library(tidyr)
library(forcats)
library(factoextra)

# 1. Filter to the relevant countries & clean
pca_data <- TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  mutate(
    risk_factor = factor(risk_factor),
    age_group   = factor(age_group)
  ) |>
  mutate(
    age_group_collapsed = case_when(
      age_group %in% c("0-14", "0-4", "5-9", "5-14", "10-14") ~ "child",
      age_group %in% c("15+", "18+", "all") ~ "*mixed_age*",
      TRUE ~ "adult"
    )
  ) |>

  
  
  # 2. Compute TB per 100k for PCA
  mutate(TB_100k = TB_cases_best / population_size * 1e5) |>
  
  # 3. Aggregate: country × age_group_collapsed × risk_factor
  group_by(country, age_group_collapsed, risk_factor) |>
  summarise(TB_100k = sum(TB_100k), .groups = "drop") |>
  
  # 4. Wide format: rows = country, columns = age:risk combinations
  unite(feature, age_group_collapsed, risk_factor, sep = "_") |>
  pivot_wider(
    names_from = feature,
    values_from = TB_100k,
    values_fill = 0   # missing combinations = 0
  )

# 5. Prepare matrix for PCA
pca_matrix <- pca_data |> 
  select(-country) |> 
  as.matrix()

rownames(pca_matrix) <- pca_data$country

# 6. Run PCA
pca_res <- prcomp(pca_matrix, scale. = TRUE)

# 7. PCA biplot using factoextra
fviz_pca_biplot(
  pca_res,
  repel = TRUE,
  col.var = "red",      # variable arrows
  col.ind = "black",    # country labels
  title = "PCA biplot of TB profiles (risk factor × age group)"
)
```

---------------------------------------------

**TB cases relative to risk factors AND sex:**

```{r}
TB_age_sex
```

```{r}
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all")) |> #Remove the undesired age-groups
  filter(country %in% top_10_countries_100k) |> #Getting only the top 10 most infected countries
  group_by(age_group)  
```

```{r}
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all")) |> 
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_pr_100k_best, na.rm = TRUE),
    total_min  = sum(TB_cases_pr_100k_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_pr_100k_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  )
```

```{r}
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all")) |> 
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_pr_100k_best, na.rm = TRUE),
    total_min  = sum(TB_cases_pr_100k_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_pr_100k_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  )
```

```{r}
#Total amount of TB cases pr. 100k, summed. 

TB_age_sex |>
  group_by(country) |>
  summarise(
    total_pr_100k = max(total_TB_cases_pr_100k_best)
  ) |>
  summarise(sum_of_TB_pr_100k_citizens = sum(total_pr_100k))
```

```{r}
#Total amount of TB cases pr. 100k, summed - Only age groups of interest. 

TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all")) |> 
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_pr_100k_best, na.rm = TRUE),
    total_min  = sum(TB_cases_pr_100k_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_pr_100k_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  ) |>
  summarise(sum_of_TB_pr_100k_citizens = sum(total_best))
```

```{r}
#Total amount of TB cases pr. 100k, summed - Only age groups and countries of interest. 

TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  filter(!age_group %in% c("15+", "18+", "all")) |> 
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_pr_100k_best, na.rm = TRUE),
    total_min  = sum(TB_cases_pr_100k_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_pr_100k_max,  na.rm = TRUE)
  ) |>
  mutate(
    age_lower = as.numeric(str_extract(age_group, "^[0-9]+")),
    age_lower = ifelse(is.na(age_lower), Inf, age_lower)
  ) |>
  summarise(sum_of_TB_pr_100k_citizens = sum(total_best))
```

```{r}
TB_age_sex |>
  filter(!age_group %in% c("15+", "18+", "all")) |> 
  group_by(age_group) |>
  summarise(
    total_best = sum(TB_cases_pr_100k_best, na.rm = TRUE),
    total_min  = sum(TB_cases_pr_100k_min,  na.rm = TRUE),
    total_max  = sum(TB_cases_pr_100k_max,  na.rm = TRUE)
  )
```

```{r}
TB_age_sex |>
  group_by(country) |>
  summarise(average = mean(TB_cases_pr_100k_best, na.rm = TRUE)) |> #Just taking the mean for now, even tho it is a constant value for every country. 
  arrange(desc(average))

```

```{r}
ggplot(TB_age_sex,
       aes(x = TB_cases_pr_100k_best,
           y = population_size)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "TB cases per 100k (best estimate)",
    y = "Population size",
    title = "TB incidence vs population size"
  ) +
  theme_minimal()
```

```{r}
ggplot(TB_age_sex,
       aes(y = country, x = TB_cases_pr_100k_best)) +
  geom_boxplot(alpha = 1) +
  theme(legend.position = "none")
```

```{r}
#Box plot for all countries: 

#| echo: true
#| eval: true

ggplot(TB_age_sex,
       aes(y = country, x = TB_cases_best)) +
  geom_boxplot(alpha = 1) +
  theme(legend.position = "none") +  
  labs(
    x = "TB cases",
    y = "Countries"
  ) 
```

```{r}
#Boxplot of the top 10 countries with most total TB cases: 

#| echo: true
#| eval: true

# Compute total cases per country
top_countries <- TB_age_sex |>
  group_by(country) |>
  summarise(total_cases = sum(TB_cases_best, na.rm = TRUE)) |>
  arrange(desc(total_cases)) |>
  slice_head(n = 10) |>  # top 10 countries
  pull(country)

# Filter the data
TB_top <- TB_age_sex |> filter(country %in% top_countries)

# Boxplot
ggplot(TB_top, aes(y = country, x = TB_cases_best)) +
  geom_boxplot(alpha = 0.7, fill = "skyblue") +
  labs(x = "TB cases", y = "Country") +
  theme_minimal()
```

```{r}

#| echo: true
#| eval: true

ggplot(TB_top, aes(y = country, x = TB_cases_best)) +
  geom_boxplot(alpha = 0.7, fill = "salmon") +
  scale_x_log10() +
  labs(x = "TB cases (log scale)", y = "Country") +
  theme_minimal()
```

```{r}
#grouping low-incidence countries together: 

TB_data_summary <- TB_age_sex |>
  group_by(country) |>
  summarise(total_cases = sum(TB_cases_best, na.rm = TRUE)) |>
  mutate(country_group = if_else(total_cases < 50000, "Other", country))

ggplot(TB_data_summary, aes(y = country_group, x = total_cases)) +
  geom_boxplot() +
  scale_x_log10()


```

------------------------------------------------------------------------

```{r}
#All countries: 
# unique(TB_data$country)

```

#### Total TB cases per country:

```{r}
#Getting the total amount of TB cases pr. country: 

#| echo: true
#| eval: true

TB_cases_by_country <- TB_age_sex |>
  group_by(country) |>
  summarise(
    total_cases = sum(TB_cases_best, na.rm = TRUE)
  )

print(TB_cases_by_country)
```

Cases in Denmark:

```{r}
#| echo: true
#| eval: true

TB_cases_by_country |>
  filter(country == "Denmark")
```

```{r}
#Only the numeric value: 

TB_cases_by_country |>
  filter(country == "Denmark") |>
  pull(total_cases) #pull() allows a specific element from a tibble to be extracted. 
  
```

```{r}
#Getting the total amount of TB cases pr. sex and pr. country: 

#| echo: true
#| eval: true

TB_cases_by_sex <- TB_age_sex |>
  group_by(country, sex) |> 
  summarise(
    total_cases = sum(TB_cases_best, na.rm = TRUE)
  ) |>
  ungroup()

print(TB_cases_by_sex)

```

```{r}
#Box plot for sex-segmented data: 

#| echo: true
#| eval: true

ggplot(TB_cases_by_sex,
       aes(y = country, x = total_cases)) +
  geom_boxplot(alpha = 1) +
  theme(legend.position = "none") +  
  labs(
    x = "TB cases",
    y = "Countries"
  ) 
```

------------------------------------------------------------------------

------------------------------------------------------------------------

------------------------------------------------------------------------

# Data Visualization II (PCA, heatmap)

```{r}

#| echo: true
#| eval: true

#Assigning the data with pr. 100k to a variable
TB_PCA_prep <- TB_age_sex |>
  group_by(country) |>
  mutate(total_TB_cases_best = sum(TB_cases_best), total_TB_cases_min = sum(TB_cases_min), total_TB_cases_max = sum(TB_cases_max)) |> #Getting the total sum of TB cases for every country
  ungroup() |>
  mutate(TB_cases_pr_100k_best = total_TB_cases_best/10^5, TB_cases_pr_100k_min = total_TB_cases_min/10^5, TB_cases_pr_100k_max = total_TB_cases_max/10^5)
```

PCA is carries out across countries to check different TB_profiles across countries

```{r}

#| echo: true
#| eval: true

 # Aggregate TB per 100k data to country level

TB_country <- TB_PCA_prep |> 
  group_by(country) |> 
  summarise(
    best_TB_100k = mean(TB_cases_pr_100k_best, na.rm = TRUE),
    min_TB_100k  = mean(TB_cases_pr_100k_min, na.rm = TRUE),
    max_TB_100k  = mean(TB_cases_pr_100k_max, na.rm = TRUE), 
    
#We use meam because 100k-normalized values reflect rates per 100k, not absolute counts.
#Summing them would give nonsense (e.g., “4500 TB per 100k”).

    male_best_100k   = mean(TB_cases_pr_100k_best[sex == "Male"], na.rm = TRUE),
    female_best_100k = mean(TB_cases_pr_100k_best[sex == "Female"], na.rm = TRUE),
    both_best_100k   = mean(TB_cases_pr_100k_best[sex == "Both"], na.rm = TRUE),

    population = unique(population_size)[1]
  ) |> 
  ungroup()

```

```{r}
#| echo: true
#| eval: true

# Preapare data for PCA
TB_country_pca <- TB_country |> 
  select(best_TB_100k, min_TB_100k, max_TB_100k)

```

```{r}
#| echo: true
#| eval: true

#Scale and run PCA
pca_scaled <- scale(TB_country_pca)
pca_res <- prcomp(pca_scaled, center = TRUE, scale. = TRUE)


TB_pca_scores <- as.data.frame(pca_res$x)
TB_pca_scores$country <- TB_country$country


```

```{r}
#PCA plot
ggplot(TB_pca_scores,
       aes(x = PC1, y = PC2, label = country)) +
  geom_point(alpha = 0.7, color = "steelblue", size = 2.8) +
  geom_text(size = 2.5, vjust = -0.8) +
  theme_minimal() +
  labs(
    title = "PCA of TB Burden Indicators (Country Level)",
    x = paste0("PC1 (", round(summary(pca_res)$importance[2,1] * 100, 1), "% variance)"),
    y = paste0("PC2 (", round(summary(pca_res)$importance[2,2] * 100, 1), "% variance)")
  )

```

```{r}
library(ggplot2)

pca_scores <- as.data.frame(pca_res$x)
pca_loadings <- as.data.frame(pca_res$rotation)

ggplot() +
  geom_point(
    data = pca_scores,
    aes(x = PC1, y = PC2),
    size = 3,
    alpha = 0.7
  ) +
  geom_segment(
    data = pca_loadings,
    aes(x = 0, y = 0, xend = PC1*2, yend = PC2*2),
    arrow = arrow(length = unit(0.2, "cm")),
    color = "red"
  ) +
  geom_text(
    data = pca_loadings,
    aes(x = PC1*2, y = PC2*2, label = rownames(pca_loadings)),
    color = "red",
    vjust = -0.5
  ) +
  theme_minimal() +
  labs(title = "PCA Biplot (Clean ggplot Version)")

```

```{r}
# Heatmap of top 10 countries (per 100k)
# | echo: true
# | eval: true

# 1. Identify top 10 countries by total TB per 100k
top10 <- TB_PCA_prep |>
  group_by(country) |>
  summarise(total_cases_100k = sum(TB_cases_pr_100k_best, na.rm = TRUE)) |>
  slice_max(total_cases_100k, n = 10) |>
  pull(country)

# 2. Create heatmap dataset
TB_heat <- TB_PCA_prep|>
  filter(country %in% top10) |>
  group_by(country, age_group) |>
  summarise(total_cases_100k = sum(TB_cases_pr_100k_best, na.rm = TRUE)) |>
  ungroup()

# 3. Plot heatmap
ggplot(TB_heat, aes(x = age_group, y = country, fill = total_cases_100k)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "D") +
  theme_minimal() +
  labs(
    title = "Heatmap of TB Burden per 100k Across Age Groups (Top 15 Countries)",
    x = "Age Group",
    y = "Country",
    fill = "TB per 100k"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```
