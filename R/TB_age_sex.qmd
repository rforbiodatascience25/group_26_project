---
title: "TB_R_course"
format: html
---

WHO 2025 data on Tuberculosis.

In this script, we will be working with the following dataset:

"***WHO TB incidence estimates disaggregated by age group, sex and risk factor \[\>0.5Mb\]***"

Link:

<https://www.who.int/teams/global-programme-on-tuberculosis-and-lung-health/data#csv_files>

Important: It may look like R only downloaded the data for countries from A to B.

But that is just a visualization thing in order to save memory.

------------------------------------------------------------------------

**Note to self - add this in all code chunks when wrapping up:**

```{r}
#| echo: true
#| eval: true
```

**Loading relevant libraries:**

```{r}
library(tidyverse) #The main package of the course. Allows us to load nifty table-like structures. A bit similar to Pandas from Python. 
library(dplyr)     #Allows us to make the |> pipelines when manipulating data. 
library(stringr)   #Allows for string manipulation. Can be good when you e.g. want to rename stuff.
library(ggplot2)   #For making cool plots. 
```

**Loading data:**

WHO TB incidence estimates disaggregated by age group, sex and risk factor \[\>0.5Mb\]

```{r}
#Loading age and sex and risk group data (2024 only): 

data_folder <- "../Data"
data_file   <- file.path(data_folder, "TB_age_sex.csv")
data_url    <- "https://extranet.who.int/tme/generateCSV.asp?ds=estimates_age_sex"


####################################

# Ensure Data folder exists

if (!dir.exists(data_folder)) {
  message("Creating Data folder…")
  dir.create(data_folder)
}

####################################

# Load from disk OR download & save it through the link above: 

if (file.exists(data_file)) {
  
  message("Loading TB_age_sex from local file…")
  TB_age_sex <- read_csv(
    file = data_file,
    show_col_types = FALSE
  )
  
} else {
  
  message("Local file not found. Downloading from WHO's website…")
  TB_age_sex <- read_csv(
    file = data_url,
    show_col_types = FALSE
  )
  
  message("Saving dataset to Data/TB_age_sex.csv…")
  write_csv(
    x = TB_age_sex,
    file = data_file
  )
}

#Display the data: 
TB_age_sex

```

(Quick note: I have included the use of *if-statements*, which might be considered a bit outside the curriculum. I only do it in order to make a flexible code that ensures that the data is only downloaded online if it has not already been downloaded by the user before (first time running the code) - in order not to waste computational resources, as Leon mentioned that there were some memory problems on the cluster.

**Comments about the data:**

Shows estimated TB cases for different countries.

This particular dataset only contains data from **2024**.

Shows metadata about **age** groups, **sex**, and **risk factors** (e.g., HIV).

Furthermore, it shows the best estimate of TB cases ("**best**" column) a high bound of that estimate ("**hi**" column), and a lower bound of that estimate ("**lo**" column).

### **Data exploration and cleaning:**

```{r}
#Summary statistics

#Note: The output is not very pretty. Use the code block below. 

#summary(TB_age_sex)

```

```{r}
#Some summary statistics: 


TB_age_sex |> 
  summarise(
    n_rows = n(),
    n_countries = n_distinct(country),
    n_years = n_distinct(year),
    n_sex_categories = n_distinct(sex),
    min_year = min(year, na.rm = TRUE),
    max_year = max(year, na.rm = TRUE),
    total_cases_best = sum(best, na.rm = TRUE),
    total_cases_lo = sum(lo, na.rm = TRUE),
    total_cases_hi = sum(hi, na.rm = TRUE)
  )

```

9031 rows, 182 countries, 3 sex categories (male, female, and aggregated (aka. "both")), a total estimate of 71,744,072 TB cases (**\~72 million TB cases in 2024**).

```{r}
#All unique values in the "meaure" column
unique(TB_age_sex$measure)
```

```{r}
#All unique values in the "unit" column
unique(TB_age_sex$unit)
```

"Unit = num" and "Measure = inc" mean that it is the number of TB incidences that year.

**Renaming columns in the data:**

```{r}
#Adjusting some of the column names, to make them more intuitive. 
TB_age_sex <- TB_age_sex |> 
  rename(
    iso_code = iso3,
    TB_cases_best = best,
    TB_cases_min = lo,
    TB_cases_max = hi
  )
```

```{r}
TB_age_sex
```

Note: The age group sometimes contains info like "15plus" instead of e.g. "15-100" or "15+".

Changing the sex: f, m, a to female, male, both (aggregated)

```{r}
#The 'case_when()' function is used to change the values. 
#It works as a replace function. 

TB_age_sex <- TB_age_sex |> 
  mutate( 
    sex = case_when( 
      sex == "m" ~ "Male", 
      sex == "f" ~ "Female", 
      sex == "a" ~ "Both", 
    ) 
  ) 

print(TB_age_sex)
```

```{r}
#Sanity/ quality check: 
print( unique(TB_age_sex$sex) ) 

#Printing the unique values from the "sex" column
#It should only return Male, Female and Both. 

```

Arguably, the columns for "iso2", "iso_code", iso_numeric", "measure" and "unit" don't present any particularly valuable info, so we will just remove those columns.

**Remove irrelevant columns:**

```{r}
TB_age_sex <- TB_age_sex |>
  select(-"iso2", -"iso_code", -"iso_numeric", -"measure", -"unit") #The minus sign tells R to NOT select those columns. 

```

```{r}
print(TB_age_sex)
```

**All of the risk factors in the data:**

```{r}
unique(TB_age_sex$risk_factor)
```

all = all risk factors combined.

alc = alcoholism

smk = smoking

dia = diabetes

hiv = HIV infected

und = undernourishment

```{r}
TB_age_sex <- TB_age_sex |> 
  mutate( 
    risk_factor = case_when( 
      risk_factor == "all" ~ "all", #stay the way it is. 
      risk_factor == "alc" ~ "alcoholism", 
      risk_factor == "smk" ~ "smoking", 
      risk_factor == "dia" ~ "diabetes", 
      risk_factor == "hiv" ~ "HIV", #capital letters
      risk_factor == "und" ~ "undernourishment" 
    ) 
  ) 
```

Sanity check:

```{r}
unique(TB_age_sex$risk_factor)
```

Last adjustments to the data would be correcting the "age_group" so e.g. "15plus" becomes "15+".

```{r}
unique(TB_age_sex$age_group)
```

```{r}
TB_age_sex <- TB_age_sex |>
  mutate(age_group = str_replace(age_group, "plus", "+")) #str_replace is from 'stringr'
```

```{r}
#Sanity check: 
unique(TB_age_sex$age_group)
```

**Checking if there are any NA values in the data:**

```{r}
#Checking for NA values throughout entire dataset: 
any(is.na(TB_age_sex))
```

Could also have used this code to inspect each of the columns individually:

```{r}
TB_age_sex |>
  summarise(across(everything(), ~ any(is.na(.))))
```

As there are no further NA values, in the remaining, cleaned data, it seems fair to conclude the cleaning of the data here.

Finally, let's sample only the data from Denmark, just to get some insights:

```{r}
TB_age_sex |>
  filter(country == "Denmark", sex == "Both")
```

It is worth noting that (at least for Denmark) the risk factors are only reported on the "sex = Both" grouped data.

Based on the tibble above, it becomes clear that 'risk factor = all' might not be what we originally thought:

```{r}
#Understanding the "all" risk label: 
TB_age_sex |>
  filter(country == "Denmark", risk_factor != "all") |> #The ones that are not labelled "all". 
  summarise(sum_TB = sum(TB_cases_best))
```

```{r}
TB_age_sex |>
  filter(country == "Denmark", risk_factor == "all") |> #The ones that ARE labelled "all". 
  summarise(sum_TB = sum(TB_cases_best))
```

'Risk factor = all' is not specified anywhere in the WHO report.

Therefore, based on the analysis above, it seems safe to draw the conclusion that 'risk factor = all' actually means 'risk factor = no risk factor'.

We will therefore rename the value accordingly:

```{r}
TB_age_sex <- TB_age_sex |>
  mutate(
    risk_factor = case_when(
      risk_factor == "all" ~ "no risk factor",
      TRUE ~ risk_factor        # keep all other values as they are
    )
  )

```

This was a nice case of how critical thinking can help out when official descriptions of the dataset fall short.

```{r}
TB_age_sex
```

------------------------------------------------------------------------

As one of the last steps, we wanna merge some of the data from the other datasets onto this dataset.

Specifically, we would like to obtain the information regarding the total population of each country, and merge it into our tibble.

We can use the '***WHO TB burden estimates \[\>1Mb\]***' dataset to obtain the information about the population.

Note: This dataset contains data from years other than 2024, so we can either filter those years away, or we can count for this in the way we merge.

**Loading additional data in order to merge:**

```{r}

#data_folder <- "../Data" #Was already defined 
data_file   <- file.path(data_folder, "TB_burden.csv")
data_url    <- "https://extranet.who.int/tme/generateCSV.asp?ds=estimates"


####################################

# Ensure Data folder exists

if (!dir.exists(data_folder)) {
  message("Creating Data folder…")
  dir.create(data_folder)
}

####################################

# Load from disk OR download & save it through the link above: 

if (file.exists(data_file)) {
  
  message("Loading TB_burden from local file…")
  TB_burden <- read_csv(
    file = data_file,
    show_col_types = FALSE
  )
  
} else {
  
  message("Local file not found. Downloading from WHO's website…")
  TB_burden <- read_csv(
    file = data_url,
    show_col_types = FALSE
  )
  
  message("Saving dataset to Data/TB_age_sex.csv…")
  write_csv(
    x = TB_burden,
    file = data_file
  )
}

#Display the data: 
TB_burden
```

```{r}
#Making dataset containing all population data (2024) for every country. 
population_data_2024 <- TB_burden |>
  select(country, e_pop_num, year) |>
  filter(year == 2024) |>
  rename(population_size = e_pop_num)

population_data_2024
```

**Joining population data to main data:**

```{r}
TB_age_sex <- left_join(TB_age_sex, population_data_2024, by = c("country", "year"))
TB_age_sex
```

Note: The population size is kept constant in all rows, but e.g., Afghanistan has several rows for e.g. different age groups, where the TB cases varies - so TB varies, but population size is constant for each row (country specific).

**Data augmentation:**

Lastly, we can make a column which shows the amount of TB cases pr. 100k citizens in the country. This normalization will help make the TB cases more comparable for all countries, and makes the comparison more indepedent on the population size.

```{r}
TB_age_sex |>
  group_by(country) |>
  mutate(total_TB_cases_best = sum(TB_cases_best), total_TB_cases_min = sum(TB_cases_min), total_TB_cases_max = sum(TB_cases_max)) |> #Getting the total sum of TB cases for every country
  ungroup() |>
  mutate(TB_cases_pr_100k_best = total_TB_cases_best/10^6, TB_cases_pr_100k_min = total_TB_cases_min/10^6, TB_cases_pr_100k_max = total_TB_cases_max/10^6)
  
```

Final (sanity) check if we have any NA values:

```{r}
TB_age_sex |>
  summarise(across(everything(), ~ any(is.na(.))))
```

OK, we are all clear B)))

That wraps up all of the data cleaning (for real, this time!)

### **Data visualization:**

```{r}
#Box plot for all countries: 

#| echo: true
#| eval: true

ggplot(TB_age_sex,
       aes(y = country, x = TB_cases_best)) +
  geom_boxplot(alpha = 1) +
  theme(legend.position = "none") +  
  labs(
    x = "TB cases",
    y = "Countries"
  ) 
```

```{r}
#Boxplot of the top 10 countries with most total TB cases: 

#| echo: true
#| eval: true

# Compute total cases per country
top_countries <- TB_age_sex |>
  group_by(country) |>
  summarise(total_cases = sum(TB_cases_best, na.rm = TRUE)) |>
  arrange(desc(total_cases)) |>
  slice_head(n = 10) |>  # top 10 countries
  pull(country)

# Filter the data
TB_top <- TB_age_sex |> filter(country %in% top_countries)

# Boxplot
ggplot(TB_top, aes(y = country, x = TB_cases_best)) +
  geom_boxplot(alpha = 0.7, fill = "skyblue") +
  labs(x = "TB cases", y = "Country") +
  theme_minimal()
```

```{r}

#| echo: true
#| eval: true

ggplot(TB_top, aes(y = country, x = TB_cases_best)) +
  geom_boxplot(alpha = 0.7, fill = "salmon") +
  scale_x_log10() +
  labs(x = "TB cases (log scale)", y = "Country") +
  theme_minimal()
```

```{r}
#grouping low-incidence countries together: 

TB_data_summary <- TB_age_sex |>
  group_by(country) |>
  summarise(total_cases = sum(TB_cases_best, na.rm = TRUE)) |>
  mutate(country_group = if_else(total_cases < 50000, "Other", country))

ggplot(TB_data_summary, aes(y = country_group, x = total_cases)) +
  geom_boxplot() +
  scale_x_log10()


```

------------------------------------------------------------------------

```{r}
#All countries: 
# unique(TB_data$country)

```

#### Total TB cases per country:

```{r}
#Getting the total amount of TB cases pr. country: 

#| echo: true
#| eval: true

TB_cases_by_country <- TB_age_sex |>
  group_by(country) |>
  summarise(
    total_cases = sum(TB_cases_best, na.rm = TRUE)
  )

print(TB_cases_by_country)
```

Cases in Denmark:

```{r}
#| echo: true
#| eval: true

TB_cases_by_country |>
  filter(country == "Denmark")
```

```{r}
#Only the numeric value: 

TB_cases_by_country |>
  filter(country == "Denmark") |>
  pull(total_cases) #pull() allows a specific element from a tibble to be extracted. 
  
```

```{r}
#Getting the total amount of TB cases pr. sex and pr. country: 

#| echo: true
#| eval: true

TB_cases_by_sex <- TB_age_sex |>
  group_by(country, sex) |> 
  summarise(
    total_cases = sum(TB_cases_best, na.rm = TRUE)
  ) |>
  ungroup()

print(TB_cases_by_sex)

```

```{r}
#Box plot for sex-segmented data: 

#| echo: true
#| eval: true

ggplot(TB_cases_by_sex,
       aes(y = country, x = total_cases)) +
  geom_boxplot(alpha = 1) +
  theme(legend.position = "none") +  
  labs(
    x = "TB cases",
    y = "Countries"
  ) 
```

------------------------------------------------------------------------

------------------------------------------------------------------------

------------------------------------------------------------------------
