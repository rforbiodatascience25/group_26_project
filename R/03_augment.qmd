---
title: "03_augment"
format: html
---

WHO 2025 data on Tuberculosis.

In this script, we will be working with the data augmentation (where requiered) and joining of data into two final tables, one containing the information from WHO TB burden estimates [>1Mb], WHO MDR/RR-TB burden estimates and WHO TB infection estimates in household contacts. The other one will include the formation from WHO TB incidence estimates disaggregated by age group, sex and risk factor [>0.5Mb] as it's only information from 2024.

------------------------------------------------------------------------

**Note to self - add this in all code chunks when wrapping up:**

```{r}
#| echo: true
#| eval: true
```

**Loading relevant libraries:**

```{r}
library("tidyverse") 
```

```{r}
#Access to the function for loading the datasets and to save them
source("99_proj_func.R")
```

------------------------------------------------------------------------

**Loading data:**

WHO TB incidence estimates disaggregated by age group, sex and risk factor \[\>0.5Mb\]

```{r}
#Loading age and sex and risk group data (2024 only): 

data_file   <- "TB_age_sex.tsv"
TB_age_sex  <- load_data(data_file)

#Display the data: 
TB_age_sex

```

WHO TB burden estimates \[\>1Mb\]:

```{r}
#Loading TB burden estimates: 

data_file   <- "TB_burden.tsv"
TB_burden   <- load_data(data_file)

#Display the data: 
TB_burden
```

WHO MDR/RR-TB burden estimates:

```{r}
#Loading MDR/RR-TB burden estimates

data_file     <- "MDR_RR_burden_estimates.tsv"
mdr_rr_data   <- load_data(data_file)

#Display the data_
mdr_rr_data
```

WHO LTBI (household contacts) estimates:

```{r}
#Loading LTBI estimates (Household contacts) data:

data_file   <- "LTBI_estimates.tsv"
ltbi_data   <- load_data(data_file)

#Display the data: 
ltbi_data
```

------------------------------------------------------------------------

**Joining the data of 2024:**

We wanna merge some of the data from the other datasets onto this dataset.

Specifically, we would like to obtain the information regarding the total population of each country, and merge it into our tibble.

We can use the '***WHO TB burden estimates \[\>1Mb\]***' dataset to obtain the information about the population.

Note: This dataset contains data from years other than 2024, so we can either filter those years away, or we can count for this in the way we merge.

**Filtering the additional data of 2024 in order to merge:**

```{r}
#Making dataset containing all population data (2024) for every country. 
population_data_2024 <- TB_burden |>
  select(country, e_pop_num, year) |>
  filter(year == 2024) |>
  rename(population_size = e_pop_num)

population_data_2024
```

**Joining population data to main data:**

```{r}
TB_age_sex <- left_join(TB_age_sex, population_data_2024, by = c("country", "year"))
TB_age_sex
```

Note: The population size is kept constant in all rows, but e.g., Afghanistan has several rows for e.g. different age groups, where the TB cases varies - so TB varies, but population size is constant for each row (country specific).

**Data augmentation:**

Lastly, we can make a column which shows the amount of TB cases pr. 100k citizens in the country. This normalization will help make the TB cases more comparable for all countries, and makes the comparison more indepedent on the population size.

```{r}
#Data augmentation - TB cases pr. 100k citizens. 

TB_age_sex <- TB_age_sex |>
  group_by(country) |>
  mutate(total_TB_cases_best = sum(TB_cases_best), total_TB_cases_min = sum(TB_cases_min), total_TB_cases_max = sum(TB_cases_max)) |> #Getting the total sum of TB cases for every country
  ungroup() |>
  mutate(TB_cases_pr_100k_best = total_TB_cases_best/10^5, TB_cases_pr_100k_min = total_TB_cases_min/10^5, TB_cases_pr_100k_max = total_TB_cases_max/10^5)
  
```

Final (sanity) check if we have any NA values:

```{r}
TB_age_sex |>
  summarise(across(everything(), ~ any(is.na(.))))
```

OK, we are all clear B)))

Save joined data:

```{r}
save_data(TB_age_sex, "TB_age_sex_joined.tsv")
```

------------------------------------------------------------------------

**Joining the data of 2015 to 2024:**

We wanna merge the data from WHO TB burden estimates [>1Mb], WHO MDR/RR-TB burden estimates and WHO TB infection estimates in household contacts onto this dataset.

Specifically, we would like to obtain the information ####

**Joining the three tables:**

```{r}
TB_10_years <- inner_join(TB_burden, mdr_rr_data, by = c("country", "year"))
TB_10_years <- inner_join(TB_10_years, ltbi_data, by = c("country", "year"))
TB_10_years
```

Final (sanity) check to inspect where there are any NA values:

```{r}
enframe(colSums(is.na(TB_10_years)), name = "Column", value = "NA_Count")
```

As we can see there are many NA values, which is expected because not all countries can provide all the information to fill these tables.

Save joined data:

```{r}
save_data(TB_10_years, "TB_10_years_joined.tsv")
```
