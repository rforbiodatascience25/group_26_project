---
title: "03_augment"
format: html
---

WHO 2025 data on Tuberculosis.

In this script, we will be working with the data augmentation (where required) and joining of data into two final tables.

We will create one containing the information from the 3 datasets, which spans all of the years:

(WHO TB burden estimates \[\>1Mb\] & WHO MDR/RR-TB burden estimates & WHO TB infection estimates in household contacts)

-   This will lead to the data being worked with in **05_analysis_1.qmd**

The other augmented dataset will include data from the remaining dataset.

(i.e. WHO TB incidence estimates disaggregated by age group, sex and risk factor \[\>0.5Mb\])

As it only contains information from 2024, and would therefore be hard(er) to incoperate into the analysis of the other 3 datasets, which contains data from several years.

However, we will still join some population data from 2024 from the 'WHO TB burden estimates \[\>1Mb\]' dataset.

-   This will lead to the data being worked with in **06_analysis_2.qmd**

------------------------------------------------------------------------

**Loading relevant libraries:**

```{r}
library("tidyverse") 

#Access to the function for loading the datasets and to save them
source("99_proj_func.R")
```

------------------------------------------------------------------------

### **Loading data:**

**WHO TB incidence estimates disaggregated by age group, sex and risk factor \[\>0.5Mb\]:**

```{r}
#Loading age and sex and risk group data (2024 only): 

data_file   <- "TB_age_sex.tsv"
TB_age_sex  <- load_data(data_file)

#Display the data: 
slice_sample(TB_age_sex, n=5)

```

**WHO TB burden estimates \[\>1Mb\]:**

```{r}
#Loading TB burden estimates: 

data_file   <- "TB_burden.tsv"
TB_burden   <- load_data(data_file)

#Display the data: 
slice_sample(TB_burden, n=5)
```

**WHO MDR/RR-TB burden estimates:**

```{r}
#Loading MDR/RR-TB burden estimates

data_file     <- "MDR_RR_burden_estimates.tsv"
mdr_rr_data   <- load_data(data_file)

#Display the data_
slice_sample(mdr_rr_data, n=5)
```

**WHO LTBI (household contacts) estimates:**

```{r}
#Loading LTBI estimates (Household contacts) data:

data_file   <- "LTBI_estimates.tsv"
ltbi_data   <- load_data(data_file)

#Display the data: 
slice_sample(ltbi_data, n=5)
```

------------------------------------------------------------------------

### \*Data of 2024 - Joining and augmenting:

**Joining the data of 2024:**

We wanna merge some of the data from the other datasets onto this dataset.

Specifically, we would like to obtain the information regarding the total population of each country, and merge it into our tibble containing the TB age, sex and risk factor data (only has data from 2024).

We can use the '***WHO TB burden estimates \[\>1Mb\]***' dataset to obtain the information about the population size for each country.

Note: This dataset contains data from years other than 2024, so we filter those years away.

**Getting population size data from 2024:**

```{r}
#Making dataset containing all population data (2024) for every country. 
population_data_2024 <- TB_burden |>
  select(country, e_pop_num, year) |>
  filter(year == 2024) |>
  rename(population_size = e_pop_num)

slice_sample(population_data_2024, n=5)
```

**Joining population data to main data (TB_age_sex):**

```{r}
TB_age_sex <- left_join(TB_age_sex, population_data_2024, by = c("country", "year"))

TB_age_sex #Note that the population_size column is now appended. 
```

Note: The population size is kept constant in all rows, but e.g., Afghanistan has several rows for e.g. different age groups, where the TB cases varies - so TB varies, but population size is constant for each row (country specific).

**Data augmentation:**

Lastly, we can make a column which shows the amount of TB cases pr. 100k citizens in the country. I.e. a per capita normalization of the data.

This normalization will help make the TB cases more comparable for all countries, and makes the comparison more indepedent on the population size.

Because a large country is naturally going to have more TB cases than a small country.

But by using this normalization, we get a better metric for comparing the actual TB infection intensity of that country.

```{r}
#Data augmentation - TB cases pr. 100k citizens. 

TB_age_sex <- TB_age_sex |>
  group_by(country) |>
  
  #Getting the total sum of TB cases for every country
  mutate( 
    total_TB_cases_best = sum(TB_cases_best), 
    total_TB_cases_min = sum(TB_cases_min), 
    total_TB_cases_max = sum(TB_cases_max)
    ) |> 
      #Note: These total values will be constant and will span multiple rows for each country. 
  
  
      #For each row (specific age, sex and risk-factor group), 
      #calculate the pr. 100k amount of cases
  mutate( 
        TB_cases_pr_100k_best = TB_cases_best/population_size*10^5,
        TB_cases_pr_100k_min = TB_cases_min/population_size*10^5,
        TB_cases_pr_100k_max = TB_cases_max/population_size*10^5,
        
        #For each each country, calculate the summed pr. 100k amount of cases
        total_TB_cases_pr_100k_best = total_TB_cases_best/population_size*10^5,
        total_TB_cases_pr_100k_min = total_TB_cases_min/population_size*10^5, 
        total_TB_cases_pr_100k_max = total_TB_cases_max/population_size*10^5
        )
```

We normalize by:

(\<people with TB\> / \<people in entire country\>) \* 10\^5

And thereby get that there are X amount of people who have TB pr. 100k citizens in the given country.

**Check for NA values:**

```{r}
any(is.na(TB_age_sex))
```

No NA values - that is great.

**Save joined and augmented data:**

```{r}
save_data(TB_age_sex, "TB_age_sex_joined.tsv")
```

------------------------------------------------------------------------

### **\*Data of 2015 to 2024 - Joining:**

We wanna merge the data from WHO TB burden estimates \[\>1Mb\], WHO MDR/RR-TB burden estimates and WHO TB infection estimates in household contacts onto this dataset.

**Joining the three tables:**

```{r}
TB_10_years <- inner_join(TB_burden, mdr_rr_data, by = c("country", "year"))
TB_10_years <- inner_join(TB_10_years, ltbi_data, by = c("country", "year"))
TB_10_years
```

Dimensions: This spans **75 columns** and **1900 rows**.

**Removing outlayers from the join:**

```{r}
TB_10_years <- TB_10_years |>
  filter(c_cdr_pct <= 100)
```

**Counting NA values for each column:**

```{r}
enframe(colSums(is.na(TB_10_years)), name = "Column", value = "NA_Count")
```

As we can see, there are many NA values, which is expected because not all countries can provide all the information to fill these tables.

**Save the joined data for 2015-2024:**

```{r}
save_data(TB_10_years, "TB_10_years_joined.tsv")
```
