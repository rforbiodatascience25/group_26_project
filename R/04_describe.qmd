---
title: "04_describe"
format: html
---

WHO 2025 data on Tuberculosis, data description

In this script, it's intended to give an explanation on data features, using different methods and graphs. The provided data description is based on three datasets:

-   The joined dataset which only haves information from 2024
-   The joined dataset which contains information from 2015 to 2024
-   The WHO TB burden estimates \[\>1Mb\] dataset, as it contains information from previous years

Overall, the document aims to do some light-weight analysis and data exploration, prior to the heavy-weight analysis in the subsequent 2x analysis files.

------------------------------------------------------------------------

**Loading relevant libraries:**

```{r}
library(tidyverse) 
library(dplyr)
library(ggplot2)

#Access to the function for loading the datasets and to save them
source("99_proj_func.R")
```

------------------------------------------------------------------------

# **Loading data:**

**Joined dataset, year 2024:**

```{r}
#Loading age and sex and risk group data (2024 only) - Joined and augmented version of the data: 

data_file          <- "TB_age_sex_joined.tsv"
TB_age_sex_joined  <- load_data(data_file)

#Display the data: 
slice_sample(TB_age_sex_joined, n=5)
```

**Joined dataset, year 2015 to 2024:**

```{r}
#Loading age and sex and risk group data (2024 only) - Joined version of the data: 

data_file           <- "TB_10_years_joined.tsv"
TB_10_years_joined  <- load_data(data_file)

#Display the data: 
slice_sample(TB_10_years_joined, n=5)
```

**WHO TB burden estimates \[\>1Mb\]:**

```{r}
#Loading TB burden estimates: 

data_file   <- "TB_burden.tsv"
TB_burden   <- load_data(data_file)

#Display the data: 
slice_sample(TB_burden, n=5)
```

**Dictionary:**

```{r}
#Loading the data dictionary: 

data_file   <- "TB_dictionary.csv"
data_url    <- "https://extranet.who.int/tme/generateCSV.asp?ds=dictionary"
TB_dictionary <- raw_load_or_download(data_file, data_url)

slice_sample(TB_dictionary, n=5)
```

------------------------------------------------------------------------

# Data description: 

### **\*TB_age_sex_joined (2024) - Description:** 

This dataset contains the number of TB cases across different countries, categorized by age group and gender. It also includes cases per 100,000 population, enabling standardized and comparable analysis between countries.

```{r}
slice_sample(TB_age_sex_joined, n=5)

```

We can briefly explore the big differences between comparing countries based on their total TB cases vs comparing with TB cases pr. 100k citizens.

**Scatter plot of the countries with the top 10 most *TB cases in total*:**

```{r}

#Getting the 10 countries with highest total amount of TB cases:  
top_10_countries <- TB_age_sex |>
  group_by(country) |>
  summarise(total_TB = first(total_TB_cases_best)) |>
  arrange(desc(total_TB)) |>
  slice_head(n = 10) |> 
  pull(country)

#Making a tibble for those countries, and plotting them: 
TB_age_sex |>
  filter(country %in% top_10_countries) |>
  group_by(country) |>
  summarise(
    mean_best = sum(TB_cases_best, na.rm = TRUE), #Sum of TB cases for this country 
    min_val  = sum(TB_cases_min, na.rm = TRUE),
    max_val  = sum(TB_cases_max, na.rm = TRUE),
  ) |> 
  
  ggplot(aes(x = mean_best, y = fct_reorder(country, mean_best))) +
  #fct_reorder(country, mean_best) ensures that we order sort all countries,
  #based on mean_best value (descending order). 
  
  geom_point(size = 3, color = "orange") +
  geom_errorbarh(aes(xmin = min_val, xmax = max_val), height = 0.2) +
  labs(
    x = "TB cases\n(Best estimate with min/max)",
    y = "Country",
    title = "Top 10 Countries - Total TB cases, with error bars"
  ) +
  theme_minimal()
```

Note that really large countries like China and India is part of this graph.

That is not to state that TB is not a problem in these countries, but it is to highlight that the TB intensity might not be as bad as you might think.

This will make sense once you glance at the following plot.

**Scatter plot of the countries with the top 10 most *TB cases pr. 100k citizens (standardized)*:**

```{r}
#Making an object for storing the top 10 countries with most TB cases: 
top_10_countries_100k <- TB_age_sex |>
  group_by(country) |>
  summarise(
    total_TB_cases_pr_100k_best = first(total_TB_cases_pr_100k_best),
    #Note: The value is constant for each country, so we just use first()
    #in order to pick the first value (we want to reduce several rows  
    #to 1 row pr. country) 
    ) |>
  arrange(desc(total_TB_cases_pr_100k_best)) |>
  slice_head(n = 10) |>
  pull(country)

#Making a tibble for those countries, and plotting them: 
TB_age_sex |>
  filter(country %in% top_10_countries_100k) |>
  group_by(country) |>
  summarise(
    mean_best = first(total_TB_cases_pr_100k_best),
    min_val  = first(total_TB_cases_pr_100k_min),
    max_val  = first(total_TB_cases_pr_100k_max),
  ) |> 
  
  ggplot(aes(x = mean_best, y = fct_reorder(country, mean_best))) +
  #fct_reorder(country, mean_best) ensures that we order sort all countries,
  #based on mean_best value (descending order). 
  
  geom_point(size = 3, color = "orange") +
  geom_errorbarh(aes(xmin = min_val, xmax = max_val), height = 0.2) +
  labs(
    x = "TB cases pr. 100k\n(Best estimate with min/max)",
    y = "Country",
    title = "Top 10 Countries - TB cases pr. 100k citizens, with error bars"
  ) +
  theme_minimal()

```

Would you look at that!

Except for the Philippines, none of these countries were part of the plot for the "top 10 total TB cases countries".

It goes to show that the standardized TB cases pr. 100k of citizens might be a better measure for TB disease intensity of a country.

### **\*TB_10_years_joined (2015-2024) - Description:** 

We combined three WHO datasets — TB burden estimates, MDR/RR-TB burden estimates, and TB infection in household contacts — into a single multi-country, multi-year panel covering approximately 10 years.

The merged dataset contains measures of TB incidence and mortality, MDR/RR-TB incidence, and estimated household infection rates for each country–year.

This integrated dataset allows us to describe global TB trends, compare drug-resistant and drug-sensitive TB, and evaluate household transmission indicators.

(Note: Multidrug-resistant tuberculosis (MDR-TB) is defined as disease due to Mycobacterium tuberculosis that is resistant to isoniazid (H) and rifampicin (R) with or without resistance to other drugs. RR - Rifampicin resistant).

```{r}
slice_sample(TB_10_years_joined, n=5)

df10 <- TB_10_years_joined #just shortening the name so we don't have to type so much
```

Definitions of all the variables that were not renamed:

```{r}
df_colnames <- tibble(colname = colnames(df10))
df_colnames

dict_filtered <- TB_dictionary[c("variable_name", "definition")] |> 
   filter(variable_name %in% (df_colnames |> 
                                pull(colname)))
print(dict_filtered)
```

After considering the definitions, we can select only the important variables that hold the most descriptive information to get to know the data. We are selecting data per 100k to get the most comparable summary.

```{r}
df10_selection <- df10 |> 
      select(
        country,
        year,
        case_fatality_ratio = cfr,
        incidence_100k = e_inc_100k,
        incidence_hiv_100k = e_inc_tbhiv_100k,
        mortality_100k = e_mort_100k,
        mortality_hiv_100k = e_mort_tbhiv_100k,
        mortality_nohiv_100k = e_mort_exc_tbhiv_100k,
        rr_treated,
        rr_incidence,
        rr_labconf_pulm,
        contacts_best = Contacts_best,
        preventive_tx = Preventive_Tx_Pct
)
df10_selection

```

Summary statistics for main TB variables

```{r}
df10_selection %>%
  reframe(across(where(is.numeric),
                   list(mean = mean, sd = sd),
                   na.rm = TRUE))
```

Summary table of NA values (of selected values for better clarity):

```{r}
missing_summary <- df10_selection %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "n_missing") %>%
  arrange(desc(n_missing))
missing_summary

```

**Heatmap which highlights where values are missing:**

```{r}
missing_long <- df10_selection%>%
  mutate(row = row_number()) %>%
  mutate(across(everything(), as.character)) %>%   #convert values to character
  pivot_longer(-row, names_to = "variable", values_to = "value") %>%
  mutate(is_missing = is.na(value) | value == "NA")


ggplot(missing_long, aes(x = variable, y = row, fill = is_missing)) +
  geom_tile() +
  scale_fill_manual(values = c("FALSE" = "white", "TRUE" = "black")) +
  labs(title = "Missing values - Heatmap",
       x = "Variable",
       y = "Row",
       fill = "Missing") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )
```

**Missing values per country:**

```{r}
#Countries with most missing values: 
missing_by_country <- df10_selection |>
  group_by(country) |>
  summarise(
    total_rows = n(),
    total_missing = sum(is.na(across(everything()))),
    prop_missing = total_missing / (total_rows * ncol(df10))
  ) |>
  arrange(desc(prop_missing)) |> 
  slice_head(n=10)

#Top 10 countries with most missing values:
df_top10 <- df10_selection |>
  filter(country %in% missing_by_country$country) |>
  mutate(row = row_number())

#Prepare for missing values heatmap: 
missing_long <- df_top10 |>
  mutate(across(-c(country, row), ~ is.na(.))) |>  # logical missing values
  pivot_longer(-c(country, row), names_to = "variable", values_to = "is_missing")

#Plot heatmap
ggplot(missing_long, aes(x = variable, y = row, fill = is_missing)) +
  geom_tile() +
  facet_wrap(~ country, scales = "free_y") +  # separate heatmap per country
  scale_fill_manual(values = c("FALSE" = "white", "TRUE" = "black")) +
  labs(
    title = "Missing values - Heatmap for countries with the top 10 most missing values",
    x = "Variable",
    y = "Row",
    fill = "Missing"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

**Global average of trends over time:**

```{r}
df10_selection
```

```{r}
global_yearly_trends <- df10_selection |> 
  group_by(year) |> 
  summarise(
    incidence_mean = mean(incidence_100k, na.rm = TRUE),
    rr_incidence_mean = mean(rr_incidence, na.rm = TRUE),
    household_inf_mean = mean(contacts_best, na.rm = TRUE)
  )

global_yearly_trends
```

Prepare for plotting - to long shape and standardization, because variables are on different scales (per different number of people)

```{r}
global_yearly_trends_long <- global_yearly_trends |> 
  mutate(across(
    -year,
    ~ (.x - mean(.x, na.rm = TRUE)) / sd(.x, na.rm = TRUE)
  )) |> 
  
  pivot_longer(
    cols = -year,
    names_to = "variable",
    values_to = "value"
  )

global_yearly_trends_long
```

**Exploratory plots -** **Global average of TB incidence over time:**

```{r}
ggplot(global_yearly_trends_long, aes(x = year, y = value, color = variable)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = unique(global_yearly_trends_long$year)) +
  labs(
    title = "Global Yearly Trends",
    x = "Year",
    y = "Value",
    color = "Indicator"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  )
```

Interestingly, household contacts seemed to have dropped rapidly during Covid-19 quarantine (happened around april of 2020), only to increase rapidly in the time afterwards.
